# Custom ClickHouse Patch & UDF Pipeline

## Назначение

Этот каталог предназначен для кастомизации уже запущенного кластера ClickHouse (развёрнутого через base-infra/clickhouse), без потери или изменения существующих данных, users и volumes.

**Основные сценарии:**
- Массовое добавление или обновление UDF (Python-функций) для всех контейнеров
- Патчинг XML-конфигов контейнеров (например, секции <user_defined>)
- Доустановка нужных утилит внутрь контейнеров
- Легкие пост-деплой правки без пересоздания кластеров или потери данных

## Порядок использования

1. Убедитесь, что кластер ClickHouse уже запущен из base-infra/clickhouse.
2. Скопируйте новые UDF в clickhouse-udf/
3. Проверьте/отредактируйте патч-конфиг в samples/config_patch.xml.tpl
4. Запустите:
    ```bash
    terraform init
    terraform apply
    ```
5. После применения:
    - Новые UDF окажутся в user_defined всех нод
    - Секция <user_defined> в config.xml будет заменена на новую
    - Контейнеры будут перезапущены автоматически

## FAQ

- **Удалятся ли данные?**  
  Нет, никакие данные, users или volumes не удаляются, все действия происходят только в live-контейнерах.

- **Что делать, если хочу пропатчить ещё какой-то конфиг?**  
  Добавьте аналогичный null_resource с bash-скриптом, который меняет нужный файл/секцию через xmlstarlet/docker exec.

- **Как добавить новый пакет внутрь всех контейнеров?**  
  Скопируйте подходящий null_resource из install_xmlstarlet, поменяйте apk add на нужный пакет.

- **Где брать шаблоны основных конфигов?**  
  В каталоге base-infra/clickhouse/samples

- **Как откатить изменения?**  
  Просто перезапустите terraform apply из base-infra/clickhouse — он пересоберёт оригинальные конфиги без патчей.