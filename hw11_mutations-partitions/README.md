# Домашнее задание №11: Мутация данных и манипуляции с партициями

---

## Оглавление
- [Описание задания и цели](#описание-задания-и-цели)
- [Теоретическая справка](#теоретическая-справка)
- [Часть 1. Пошаговое выполнение задания](#часть-1-пошаговое-выполнение-задания)
  - [Шаг 1.1. Подготовка окружения](#шаг-11-подготовка-окружения)
  - [Шаг 1.2. Создание и заполнение таблицы](#шаг-12-создание-и-заполнение-таблицы)
  - [Шаг 1.3. Выполнение мутации (UPDATE)](#шаг-13-выполнение-мутации-update)
  - [Шаг 1.4. Проверка результатов мутации](#шаг-14-проверка-результатов-мутации)
  - [Шаг 1.5. Манипуляции с партициями (DROP PARTITION)](#шаг-15-манипуляции-с-партициями-drop-partition)
  - [Шаг 1.6. Проверка состояния таблицы после удаления](#шаг-16-проверка-состояния-таблицы-после-удаления)
- [Часть 2. Дополнительные примеры манипуляций](#часть-2-дополнительные-примеры-манипуляций)
- [Общие выводы по заданию](#общие-выводы-по-заданию)
- [Список источников](#список-источников)

---

## Описание задания и цели

В данном домашнем задании будет рассмотрена концепция мутаций данных и операций с партициями в ClickHouse. Эти механизмы являются мощными инструментами для управления жизненным циклом данных и их модификации в больших таблицах.

**Цели задания:**
-   Познакомиться с понятием мутации данных в ClickHouse и методами их выполнения.
-   Изучить основные операции манипуляции с партициями данных.
-   Научиться использовать мутации и манипуляции с партициями для эффективного управления данными.

**Компетенции, которые будут отработаны:**
-   Знание методов управления данными в ClickHouse (UPDATE/DELETE).
-   Понимание механизма асинхронных мутаций и способов их мониторинга.
-   Навыки работы с партициями для оптимизации хранения и запросов.

---

## Теоретическая справка
**Мутации** в ClickHouse (например, `ALTER TABLE ... UPDATE/DELETE`) — это тяжеловесные, асинхронные операции. В отличие от OLTP-баз, они не изменяют существующие данные "на месте". Вместо этого ClickHouse создает новые, измененные версии кусков данных (parts) и в фоновом режиме заменяет ими старые. Этот процесс может занимать время и потреблять ресурсы. Статус мутаций отслеживается в системной таблице `system.mutations`.

**Манипуляции с партициями** (`DROP PARTITION`, `REPLACE PARTITION`, `ATTACH PARTITION`) — это более легковесные операции, так как они работают на уровне метаданных, оперируя целыми каталогами данных на диске. Это делает их предпочтительным способом для удаления или атомарной замены больших объемов данных, сгруппированных по ключу партиционирования.

---

## Часть 1. Пошаговое выполнение задания

### Шаг 1.1. Подготовка окружения
Для выполнения задания будет использоваться одиночный инстанс ClickHouse, развернутый с помощью Docker Compose из каталога `base-infra`.
```sh
cd base-infra/clickhouse
docker-compose up -d
```

### Шаг 1.2. Создание и заполнение таблицы
Будет создана и наполнена данными таблица `user_activity`.

1.  **Создание таблицы:**
    Таблица партиционируется по месяцам на основе поля `activity_date`.
    ```sql
    CREATE TABLE default.user_activity
    (
        user_id UInt32,
        activity_type String,
        activity_date DateTime
    )
    ENGINE = MergeTree()
    PARTITION BY toYYYYMM(activity_date)
    ORDER BY (user_id, activity_date);
    ```

2.  **Заполнение таблицы:**
    Будут вставлены тестовые данные за разные даты.
    ```sql
    INSERT INTO default.user_activity (user_id, activity_type, activity_date) VALUES
    (101, 'login', '2025-01-15 10:00:00'),
    (102, 'login', '2025-01-15 10:05:00'),
    (101, 'purchase', '2025-01-15 12:00:00'),
    (103, 'login', '2025-02-20 11:00:00'),
    (101, 'logout', '2025-02-20 11:30:00'),
    (102, 'purchase', '2025-02-21 15:00:00');
    ```
*Результат создания и наполнения таблицы:*

<img src="../screenshots/hw11_mutations-partitions/01_create_insert.png" alt="Создание и наполнение таблицы" width="600"/>

### Шаг 1.3. Выполнение мутации (UPDATE)
Будет выполнена мутация для изменения типа активности `login` на `user_login` для всех пользователей.
```sql
ALTER TABLE default.user_activity UPDATE activity_type = 'user_login' WHERE activity_type = 'login';
```
*Результат выполнения запроса на мутацию:*

<img src="../screenshots/hw11_mutations-partitions/02_alter_update.png" alt="Выполнение мутации" width="600"/>

### Шаг 1.4. Проверка результатов мутации
1.  **Проверка статуса в `system.mutations`:**
    Мутация выполняется асинхронно. Необходимо отследить ее завершение в системной таблице. Значение `is_done = 1` означает, что мутация успешно применена ко всем кускам данных.
    ```sql
    SELECT
        mutation_id,
        command,
        create_time,
        is_done
    FROM system.mutations
    WHERE table = 'user_activity';
    ```
    *Результат проверки `system.mutations`:*

    <img src="../screenshots/hw11_mutations-partitions/03_check_mutations.png" alt="Проверка system.mutations" width="800"/>

2.  **Проверка данных в таблице:**
    После завершения мутации, необходимо убедиться, что данные действительно изменились.
    ```sql
    SELECT * FROM default.user_activity ORDER BY activity_date;
    ```
    *Результат проверки данных после мутации:*

    <img src="../screenshots/hw11_mutations-partitions/04_select_after_mutate.png" alt="Проверка данных после мутации" width="800"/>

### Шаг 1.5. Манипуляции с партициями (DROP PARTITION)
Будет удалена партиция за январь 2025 года (`202501`).
```sql
ALTER TABLE default.user_activity DROP PARTITION '202501';
```
*Результат выполнения `DROP PARTITION`:*

<img src="../screenshots/hw11_mutations-partitions/05_drop_partition.png" alt="Удаление партиции" width="600"/>

### Шаг 1.6. Проверка состояния таблицы после удаления
1.  **Проверка списка партиций:**
    Запрос к `system.parts` покажет, что партиция `202501` больше не существует.
    ```sql
    SELECT DISTINCT partition FROM system.parts WHERE table = 'user_activity';
    ```
2.  **Проверка данных:**
    Запрос к таблице подтвердит отсутствие данных за январь 2025.
    ```sql
    SELECT * FROM default.user_activity ORDER BY activity_date;
    ```
*Результат проверки партиций и данных:*

<img src="../screenshots/hw11_mutations-partitions/06_select_after_drop.png" alt="Проверка данных после удаления партиции" width="800"/>

---

## Часть 2. Дополнительные примеры манипуляций
Ниже приведены более сложные примеры, демонстрирующие другие подходы к изменению данных, включая `REPLACE PARTITION` и использование материализованных представлений.

```sql
-- Создание временной таблицы и материализованного представления для трансформации данных
CREATE TABLE default.table_two_temp (...) ENGINE = MergeTree...;
CREATE MATERIALIZED VIEW default.mv_table_two_to_temp TO default.table_two_temp AS
SELECT ..., if (`value`= 7, 7777, `value`) `value` FROM default.table_two WHERE ...;

-- Атомарная замена партиции данными из другой таблицы
ALTER TABLE table_two REPLACE PARTITION 20250501 FROM table_two_temp;

-- "Заморозка" партиции для создания бэкапа перед изменениями
ALTER TABLE table_two FREEZE PARTITION 20250501 WITH NAME '20250501';
```

---

## Общие выводы по заданию
В ходе этого задания на практике были освоены механизмы мутации данных и манипуляции с партициями в ClickHouse. Было продемонстрировано, как выполнять `UPDATE` и `DROP PARTITION`, а также как отслеживать статус асинхронных мутаций. Эти навыки являются ключевыми для эффективного управления данными и их жизненным циклом в ClickHouse.

## Список источников
- [Официальная документация ClickHouse: ALTER TABLE](https://clickhouse.com/docs/ru/sql-reference/statements/alter)
- [Официальная документация ClickHouse: system.mutations](https://clickhouse.com/docs/ru/operations/system-tables/mutations)
