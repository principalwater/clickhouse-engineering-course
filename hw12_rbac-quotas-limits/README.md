# Homework #12: RBAC –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞, –∫–≤–æ—Ç—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ü–µ–ª–∏](#–æ–ø–∏—Å–∞–Ω–∏–µ-–∑–∞–¥–∞–Ω–∏—è-–∏-—Ü–µ–ª–∏)
- [–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞](#—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è-—Å–ø—Ä–∞–≤–∫–∞)
- [–ß–∞—Å—Ç—å 1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: RBAC](#—á–∞—Å—Ç—å-1-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ-–∑–∞–¥–∞–Ω–∏—è-rbac)
  - [1.1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#11-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
  - [1.2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è](#12-—Å–æ–∑–¥–∞–Ω–∏–µ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  - [1.3. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏ –≤—ã–¥–∞—á–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π](#13-—Å–æ–∑–¥–∞–Ω–∏–µ-—Ä–æ–ª–∏-–∏-–≤—ã–¥–∞—á–∞-–ø—Ä–∏–≤–∏–ª–µ–≥–∏–π)
  - [1.4. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é](#14-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-—Ä–æ–ª–∏-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
  - [1.5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π](#15-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Å–æ–∑–¥–∞–Ω–Ω—ã—Ö-—Å—É—â–Ω–æ—Å—Ç–µ–π)
  - [1.6. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç–∏—Ä–∞–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫](#16-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è-–∏-—Ç–∏—Ä–∞–∂–∏—Ä–æ–≤–∞–Ω–∏–µ-–Ω–∞—Å—Ç—Ä–æ–µ–∫)
- [–ß–∞—Å—Ç—å 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏](#—á–∞—Å—Ç—å-2-–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-–º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Ä–µ—Å—É—Ä—Å–∞–º–∏)
  - [2.1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫](#21-—Å–æ–∑–¥–∞–Ω–∏–µ-–ø—Ä–æ—Ñ–∏–ª—è-–Ω–∞—Å—Ç—Ä–æ–µ–∫)
  - [2.2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–æ—Ç—ã](#22-—Å–æ–∑–¥–∞–Ω–∏–µ-–∫–≤–æ—Ç—ã)
  - [2.3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∫ —Ä–æ–ª–∏](#23-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ-–ø—Ä–æ—Ñ–∏–ª—è-–∫-—Ä–æ–ª–∏)
  - [2.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏](#24-–ø—Ä–æ–≤–µ—Ä–∫–∞-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- [–û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–∏—é](#–æ–±—â–∏–µ-–≤—ã–≤–æ–¥—ã-–ø–æ-–∑–∞–¥–∞–Ω–∏—é)
- [–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤](#—Å–ø–∏—Å–æ–∫-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

---

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ü–µ–ª–∏

–í –¥–∞–Ω–Ω–æ–º –¥–æ–º–∞—à–Ω–µ–º –∑–∞–¥–∞–Ω–∏–∏ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è Role-Based Access Control (RBAC), –∞ —Ç–∞–∫–∂–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∫–≤–æ—Ç –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤ ClickHouse. –≠—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —è–≤–ª—è—é—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.

**–¶–µ–ª–∏ –∑–∞–Ω—è—Ç–∏—è:**
-   –û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–æ–Ω—Ü–µ–ø—Ü–∏–µ–π RBAC –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–∞–Ω–Ω—ã–º.
-   –ò–∑—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–≤–æ—Ç –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.
-   –ù–∞—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ RBAC, —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–≤–æ—Ç –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

**–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã:**
-   –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏.
-   –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
-   –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.

---

## –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
**RBAC (Role-Based Access Control)** ‚Äî —ç—Ç–æ –º–æ–¥–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ —Ä–æ–ª—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –≤—ã–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç —Ä–æ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `developer`, `analyst`, `readonly_user`), –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏ –Ω–∞–±–æ—Ä –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `SELECT` –Ω–∞ –æ–¥–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã, `INSERT` –Ω–∞ –¥—Ä—É–≥–∏–µ), –∞ –∑–∞—Ç–µ–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –≤ —Å–∏—Å—Ç–µ–º–∞—Ö —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤.

**–ö–≤–æ—Ç—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** –≤ ClickHouse –ø–æ–∑–≤–æ–ª—è—é—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏–ª–∏ —Ä–æ–ª—è–º–∏. –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç—ã –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–æ–π –ø–∞–º—è—Ç–∏, —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å "—à—É–º–Ω—ã—Ö —Å–æ—Å–µ–¥–µ–π" –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –∫–ª–∞—Å—Ç–µ—Ä–∞.

---

## –ß–∞—Å—Ç—å 1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: RBAC

### 1.1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–ª–∞—Å—Ç–µ—Ä ClickHouse, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π —Å –ø–æ–º–æ—â—å—é Terraform –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ `base-infra`.
```sh
cd base-infra/clickhouse
terraform apply -auto-approve
```
> ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–¥–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `TF_VAR_super_user_name`, `TF_VAR_super_user_password` –∏ `TF_VAR_bi_user_password` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ DDL/DML –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ —É–∑–ª–∞ (`clickhouse-01`).

### 1.2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `jhon` —Å –ø–∞—Ä–æ–ª–µ–º `qwerty`. –ö–æ–º–∞–Ω–¥–∞ `ON CLUSTER` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞.
```sql
CREATE USER jhon ON CLUSTER dwh_test IDENTIFIED BY 'qwerty';
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:*

<img src="../screenshots/hw12_rbac-quotas-limits/01_create_user.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" width="600"/>

### 1.3. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏ –≤—ã–¥–∞—á–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Ä–æ–ª—å `devs` –∏ –µ–π –±—É–¥—É—Ç –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ (`SELECT`) –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `system.parts`.
```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞
CREATE ROLE devs ON CLUSTER dwh_test;

-- –í—ã–¥–∞—á–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π —Ä–æ–ª–∏ –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞
GRANT SELECT ON system.parts TO devs ON CLUSTER dwh_test;
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–∏ –∏ –≤—ã–¥–∞—á–∏ –ø—Ä–∞–≤:*

<img src="../screenshots/hw12_rbac-quotas-limits/02_create_role_grant.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏ –≤—ã–¥–∞—á–∞ –ø—Ä–∞–≤" width="600"/>

### 1.4. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `jhon` –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å `devs`.
```sql
GRANT devs TO jhon ON CLUSTER dwh_test;
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏:*

<img src="../screenshots/hw12_rbac-quotas-limits/03_grant_role_to_user.png" alt="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é" width="600"/>

### 1.5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã `system.users`, `system.roles` –∏ `system.grants`.

1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
    ```sql
    SELECT name FROM system.users WHERE name = 'jhon';
    ```
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏:**
    ```sql
    SELECT name FROM system.roles WHERE name = 'devs';
    ```
3.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
    ```sql
    SELECT * FROM system.role_grants WHERE user_name = 'jhon';
    ```
4.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π, –≤—ã–¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–∏:**
    ```sql
    SELECT * FROM system.grants WHERE role_name = 'devs';
    ```
*–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:*

<img src="../screenshots/hw12_rbac-quotas-limits/04_check_system_tables.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü" width="800"/>

### 1.6. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç–∏—Ä–∞–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
–ß—Ç–æ–±—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ —à–∞–≥–∏ –≤—Ä—É—á–Ω—É—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å. –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∫–æ–º–∞–Ω–¥—ã DWH –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —Ä–æ–ª—å `dwh_team`, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –Ω–µ–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞, –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –∫–≤–æ—Ç—ã, –∞ –∑–∞—Ç–µ–º –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —ç—Ç—É —Ä–æ–ª—å.

1.  **–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Ä–æ–ª–∏ `dwh_team`:**
    ```sql
    CREATE ROLE dwh_team ON CLUSTER dwh_test;
    GRANT SELECT, INSERT, ALTER, CREATE TABLE ON otus_default.* TO dwh_team ON CLUSTER dwh_test;
    ALTER ROLE dwh_team ON CLUSTER dwh_test SETTINGS PROFILE 'analytics';
    ```
2.  **–°–æ–∑–¥–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `jane`:**
    ```sql
    CREATE USER jane ON CLUSTER dwh_test IDENTIFIED BY 'password123';
    GRANT dwh_team TO jane ON CLUSTER dwh_test;
    ```
> **üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –¢–µ–ø–µ—Ä—å –¥–ª—è –ª—é–±–æ–≥–æ –Ω–æ–≤–æ–≥–æ DWH-–∏–Ω–∂–µ–Ω–µ—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ–≥–æ –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã (`CREATE USER` –∏ `GRANT dwh_team`). –í—Å–µ –ø—Ä–∞–≤–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ä–æ–ª—å, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—â–∞–µ—Ç –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞–º–∏.

*–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Ä–æ–ª–∏ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:*

<img src="../screenshots/hw12_rbac-quotas-limits/04_01_automation.png" alt="–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Ä–æ–ª—å" width="800"/>

---

## –ß–∞—Å—Ç—å 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏

–í —Ä–∞–º–∫–∞—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã –º–µ—Ö–∞–Ω–∏–∑–º—ã –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –Ω–µ–æ—Ç—ä–µ–º–ª–µ–º–æ–π —á–∞—Å—Ç—å—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è production-–∫–ª–∞—Å—Ç–µ—Ä–æ–º. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫ –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—Ç –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å `analytics`, –∫–æ—Ç–æ—Ä—ã–π –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (`max_execution_time`) –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (`max_memory_usage`).

```sql
CREATE SETTINGS PROFILE analytics ON CLUSTER dwh_test
    SETTINGS max_execution_time = 30, max_memory_usage = '2G';
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:*

<img src="../screenshots/hw12_rbac-quotas-limits/05_create_profile.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫" width="600"/>

### 2.2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–æ—Ç—ã
–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∫–≤–æ—Ç–∞ `analytics_quota`, –∫–æ—Ç–æ—Ä–∞—è –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—à–∏–±–æ–∫ –∑–∞ —á–∞—Å.

```sql
CREATE QUOTA analytics_quota ON CLUSTER dwh_test
    FOR INTERVAL 1 HOUR MAX queries = 1000, errors = 100
    TO devs;
```
> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ö–≤–æ—Ç–∞ —Å—Ä–∞–∑—É –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è —Ä–æ–ª–∏ `devs`. –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —ç—Ç–æ–π —Ä–æ–ª—å—é –±—É–¥—É—Ç –ø–æ–¥–ø–∞–¥–∞—Ç—å –ø–æ–¥ –µ–µ –¥–µ–π—Å—Ç–≤–∏–µ.

*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–≤–æ—Ç—ã:*

<img src="../screenshots/hw12_rbac-quotas-limits/06_create_quota.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–æ—Ç—ã" width="600"/>

### 2.3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∫ —Ä–æ–ª–∏
–ü—Ä–æ—Ñ–∏–ª—å `analytics` –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ —Ä–æ–ª–∏ `devs`.
```sql
ALTER ROLE devs ON CLUSTER dwh_test SETTINGS PROFILE 'analytics';
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:*

<img src="../screenshots/hw12_rbac-quotas-limits/07_alter_role_profile.png" alt="–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∫ —Ä–æ–ª–∏" width="600"/>

### 2.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:**
    ```sql
    SELECT * FROM system.settings_profiles;
    ```
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã:**
    ```sql
    SELECT * FROM system.quotas;
    ```
3.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–≤–æ—Ç—ã:**
    ```sql
    SELECT * FROM system.quota_limits WHERE quota_name = 'analytics_quota';
    ```

*–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ –∫–≤–æ—Ç:*

<img src="../screenshots/hw12_rbac-quotas-limits/08_check_profiles_quotas.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ –∫–≤–æ—Ç" width="800"/>

---

## –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–∏—é
–í —Ö–æ–¥–µ —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –±—ã–ª–∏ –æ—Å–≤–æ–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–æ—Å—Ç—É–ø–æ–º –≤ ClickHouse —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–¥–µ–ª–∏ RBAC. –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Ä–æ–ª—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã. –≠—Ç–æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ª—é–±–æ–π production-—Å–∏—Å—Ç–µ–º–µ.

## –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏](https://clickhouse.com/docs/ru/operations/access-rights)
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: CREATE USER](https://clickhouse.com/docs/ru/sql-reference/statements/create/user)
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: CREATE ROLE](https://clickhouse.com/docs/ru/sql-reference/statements/create/role)
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: GRANT](https://clickhouse.com/docs/ru/sql-reference/statements/grant)
