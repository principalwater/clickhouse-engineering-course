# Модуль ClickHouse с гибкой политикой хранения и резервным копированием

---

## Описание

Этот модуль Terraform предназначен для развертывания комплексной среды ClickHouse, включающей:
-   Кластер ClickHouse (2 шарда, 2 реплики).
-   S3-совместимое хранилище MinIO для хранения данных (опционально).
-   Удаленное S3-совместимое хранилище MinIO для резервных копий.
-   Контейнер с утилитой `altinity/clickhouse-backup` для управления бэкапами.

Модуль позволяет гибко переключаться между двумя сценариями хранения данных с помощью переменной `storage_type`.

## Архитектура и сценарии

### Аппаратное обеспечение
Данный модуль предполагает наличие следующей минимальной конфигурации:
-   **Хост-машина:** Сервер с установленным Docker, на котором будет развернут кластер ClickHouse.
-   **Внешний накопитель (опционально, для Сценария 2):** Быстрый внешний диск (SSD/NVMe), подключенный к хост-машине.
-   **Удаленный сервер:** Любой сервер с установленным Docker и SSH-доступом по ключу, на котором будет развернуто S3-хранилище для резервных копий.

> **Тестовый стенд:**
> В рамках разработки и тестирования использовалась следующая конфигурация:
> -   **Хост-машина:** Mac Studio (M2 Max, 32 ГБ RAM).
> -   **Внешний накопитель:** Samsung Portable SSD T7 2 ТБ (Thunderbolt 4).
> -   **Удаленный сервер:** Raspberry Pi 5 (8 ГБ RAM, 512 ГБ NVMe SSD).

### Сценарий 1: Локальное хранение (`storage_type = "local_ssd"`)
-   **Хранение данных:** Данные таблиц ClickHouse хранятся на основном диске хост-машины.
-   **Резервное копирование:** Бэкапы сохраняются на удаленный S3 (MinIO на Raspberry Pi).
-   **Use Case:** Максимальная производительность для "горячих" данных.

### Сценарий 2: S3-хранение (`storage_type = "s3_ssd"`)
-   **Хранение данных:** Данные таблиц ClickHouse хранятся на "локальном" S3 (MinIO на внешнем SSD), с использованием локального диска для кэширования.
-   **Резервное копирование:** Бэкапы также сохраняются на удаленный S3.
-   **Use Case:** Разделение `compute` и `storage`, что обеспечивает большую гибкость и масштабируемость хранения.

## Пошаговая инструкция по развертыванию

### 1. Предварительная настройка


1.  **Задайте переменные:**
    Рекомендуемый способ — создать в этом каталоге файл `terraform.tfvars` и указать в нем все необходимые значения.
    
    **Пример файла `terraform.tfvars`:**
    ```hcl
    super_user_name         = "su"
    super_user_password     = "your_ch_password"
    bi_user_password        = "your_bi_password"
    
    minio_root_user         = "your_minio_user"
    minio_root_password     = "your_strong_password"
    
    remote_ssh_user         = "principalwater"
    ssh_private_key_path    = "~/.ssh/water-rpi"
    remote_host_name        = "water-rpi.local"
    
    local_minio_path        = "/Volumes/Samsung_T7/minio/data"
    ```
    > **Важно:** Не забудьте добавить `*.tfvars` в ваш `.gitignore`, чтобы случайно не загрузить секреты в репозиторий.
    
    Альтернативно, можно использовать переменные окружения (`export TF_VAR_...`).

2.  **Настройте и проверьте SSH-доступ к Docker:**
    Для того чтобы Terraform мог управлять Docker на удаленном хосте, необходимо обеспечить бесшовное SSH-подключение.
    
    *   **Настройка SSH-клиента (рекомендуется):** Добавьте в ваш файл `~/.ssh/config` запись для удаленного хоста. Это позволит не указывать ключ каждый раз. Вместо переменных необходимо подставить их фактические значения:
        ```
        Host TF_VAR_remote_host_name
          HostName TF_VAR_remote_host_name
          User TF_VAR_remote_ssh_user
          IdentityFile TF_VAR_ssh_private_key_path
        ```
    *   **Проверка:** После настройки `~/.ssh/config` (или добавления ключа в `ssh-agent`), выполните команду на вашей локальной машине. Она должна выполниться без ошибок и показать список (возможно, пустой) контейнеров на удаленном хосте.
        ```sh
        docker --host ssh://${TF_VAR_remote_host_name} ps
        ```
    Если команда не работает, убедитесь, что пользователь `${TF_VAR_remote_ssh_user}` на `${TF_VAR_remote_host_name}` состоит в группе `docker`.

### 2. Развертывание

1.  **Перейдите в каталог модуля:**
    ```sh
    cd base-infra/ch_with_backup
    ```
2.  **Инициализируйте Terraform:**
    ```sh
    terraform init
    ```
3.  **Разверните инфраструктуру, выбрав один из сценариев:**
    -   **Для Сценария 1 (локальное хранение):**
        ```sh
        terraform apply -auto-approve -var="storage_type=local_ssd"
        ```
    -   **Для Сценария 2 (S3-хранение):**
        ```sh
        terraform apply -auto-approve -var="storage_type=s3_ssd"
        ```

После выполнения этих шагов будет развернут кластер ClickHouse, один или два экземпляра MinIO (в зависимости от сценария) и контейнер `clickhouse-backup`, полностью готовые к работе.
