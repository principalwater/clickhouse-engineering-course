# Модуль ClickHouse с гибкой политикой хранения и резервным копированием

---

## Описание

Этот модуль Terraform предназначен для развертывания комплексной среды ClickHouse, включающей:
-   Кластер ClickHouse (2 шарда, 2 реплики).
-   S3-совместимое хранилище MinIO для хранения данных (опционально).
-   Удаленное S3-совместимое хранилище MinIO для резервных копий.
-   Контейнер с утилитой `altinity/clickhouse-backup` для управления бэкапами.

Модуль позволяет гибко переключаться между двумя сценариями хранения данных с помощью переменной `storage_type`.

## Архитектура и сценарии

### Аппаратное обеспечение
Данный модуль предполагает наличие следующей минимальной конфигурации:
-   **Хост-машина:** Сервер с установленным Docker, на котором будет развернут кластер ClickHouse.
-   **Внешний накопитель (опционально, для Сценария 2):** Быстрый внешний диск (SSD/NVMe), подключенный к хост-машине.
-   **Удаленный сервер:** Любой сервер с установленным Docker и SSH-доступом по ключу, на котором будет развернуто S3-хранилище для резервных копий.

> **Тестовый стенд:**
> В рамках разработки и тестирования использовалась следующая конфигурация:
> -   **Хост-машина:** Mac Studio (M2 Max, 32 ГБ RAM).
> -   **Внешний накопитель:** Samsung Portable SSD T7 2 ТБ (Thunderbolt 4).
> -   **Удаленный сервер:** Raspberry Pi 5 (8 ГБ RAM, 512 ГБ NVMe SSD).

### Сценарий 1: Локальное хранение (`storage_type = "local_ssd"`)
-   **Хранение данных:** Данные таблиц ClickHouse хранятся на основном диске хост-машины.
-   **Резервное копирование:** Бэкапы сохраняются на удаленный S3 (MinIO на Raspberry Pi).
-   **Use Case:** Максимальная производительность для "горячих" данных.

### Сценарий 2: S3-хранение (`storage_type = "s3_ssd"`)
-   **Хранение данных:** Данные таблиц ClickHouse хранятся на "локальном" S3 (MinIO на внешнем SSD), с использованием локального диска для кэширования.
-   **Резервное копирование:** Бэкапы также сохраняются на удаленный S3.
-   **Use Case:** Разделение `compute` и `storage`, что обеспечивает большую гибкость и масштабируемость хранения.

## Пошаговая инструкция по развертыванию

1.  **Настройте SSH-доступ:** Убедитесь, что у вас настроен беспарольный SSH-доступ по ключу к удаленному хосту, имя которого задается переменной `remote_host_name`.
2.  **Задайте переменные окружения:**
    ```sh
    export TF_VAR_super_user_name="your_ch_user"
    export TF_VAR_super_user_password="your_ch_password"
    export TF_VAR_bi_user_password="your_bi_password"
    export TF_VAR_minio_root_user="your_minio_user"
    export TF_VAR_minio_root_password="your_strong_password"
    export TF_VAR_remote_ssh_user="your_ssh_user"
    export TF_VAR_ssh_private_key_path="~/.ssh/your_private_key"
    export TF_VAR_remote_host_name="water-rpi.local"
    ```
3.  **Перейдите в каталог модуля:**
    ```sh
    cd base-infra/ch_with_backup
    ```
4.  **Инициализируйте Terraform:**
    ```sh
    terraform init
    ```
5.  **Разверните инфраструктуру:**
    -   **Для Сценария 1 (локальное хранение):**
        ```sh
        terraform apply -auto-approve -var="storage_type=local_ssd"
        ```
    -   **Для Сценария 2 (S3-хранение):**
        ```sh
        terraform apply -auto-approve -var="storage_type=s3_ssd"
        ```

После выполнения этих шагов будет развернут кластер ClickHouse, два экземпляра MinIO (в зависимости от сценария) и контейнер `clickhouse-backup`, полностью готовые к работе.
