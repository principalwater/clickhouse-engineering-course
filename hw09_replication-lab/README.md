# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ9: –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ ClickHouse

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ü–µ–ª–∏](#–æ–ø–∏—Å–∞–Ω–∏–µ-–∑–∞–¥–∞–Ω–∏—è-–∏-—Ü–µ–ª–∏)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ –≤–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∫–ª–∞—Å—Ç–µ—Ä–∞-–∏-–≤–Ω–µ—Å—ë–Ω–Ω—ã–µ-–∏–∑–º–µ–Ω–µ–Ω–∏—è)
- [–®–∞–≥ 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∏–º–ø–æ—Ä—Ç –¥–µ–º–æ-–¥–∞—Ç–∞—Å–µ—Ç–∞](#—à–∞–≥-1-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-–∏-–∏–º–ø–æ—Ä—Ç-–¥–µ–º–æ-–¥–∞—Ç–∞—Å–µ—Ç–∞)
- [–®–∞–≥ 2. –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#—à–∞–≥-2-–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
- [–®–∞–≥ 3. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é](#—à–∞–≥-3-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è-—Ç–∞–±–ª–∏—Ü—ã-–≤-—Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é)
- [–®–∞–≥ 4. –°–æ–∑–¥–∞–Ω–∏–µ Distributed-—Ç–∞–±–ª–∏—Ü—ã](#—à–∞–≥-4-—Å–æ–∑–¥–∞–Ω–∏–µ-distributed-—Ç–∞–±–ª–∏—Ü—ã)
- [–®–∞–≥ 5. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–ø–ª–∏–∫](#—à–∞–≥-5-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ-–∫–ª–∞—Å—Ç–µ—Ä–∞-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ-–Ω–æ–≤—ã—Ö-—Ä–µ–ø–ª–∏–∫)
- [–®–∞–≥ 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞](#—à–∞–≥-6-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Å–æ—Å—Ç–æ—è–Ω–∏—è-–∫–ª–∞—Å—Ç–µ—Ä–∞)
- [–®–∞–≥ 7. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –¥–∞–Ω–Ω—ã—Ö (TTL)](#—à–∞–≥-7-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–∂–∏–∑–Ω–µ–Ω–Ω—ã–º-—Ü–∏–∫–ª–æ–º-–¥–∞–Ω–Ω—ã—Ö-ttl)
- [–®–∞–≥ 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ (—Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç)](#—à–∞–≥-8-–ø—Ä–æ–≤–µ—Ä–∫–∞-–æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏-—Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç)
- [–û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–∏—é](#–æ–±—â–∏–µ-–≤—ã–≤–æ–¥—ã-–ø–æ-–∑–∞–¥–∞–Ω–∏—é)
- [–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤](#—Å–ø–∏—Å–æ–∫-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

---

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ü–µ–ª–∏

–í –¥–∞–Ω–Ω–æ–º –¥–æ–º–∞—à–Ω–µ–º –∑–∞–¥–∞–Ω–∏–∏ –∏–∑—É—á–∞–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ ClickHouse –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞. –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –∞ TTL –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä—ë–º–∞–º–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–¶–µ–ª–∏ –∑–∞–¥–∞–Ω–∏—è:
- –°–æ–∑–¥–∞—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é —Ç–∞–±–ª–∏—Ü—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–≤–∏–∂–∫–∞ `ReplicatedMergeTree`.
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —à–∞—Ä–¥–∞–º–∏ –∏ —Ä–µ–ø–ª–∏–∫–∞–º–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∫–æ–¥ (Terraform).
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø—É—Ç–µ–º –∏–º–∏—Ç–∞—Ü–∏–∏ —Å–±–æ—è –Ω–æ–¥—ã.

–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã:
- –†–∞–±–æ—Ç–∞ —Å –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏ ClickHouse –∏ –¥–≤–∏–∂–∫–æ–º `ReplicatedMergeTree`.
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —á–µ—Ä–µ–∑ Terraform.
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TTL –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –¥–∞–Ω–Ω—ã—Ö.
- –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø—Ä–∏ —Å–±–æ—è—Ö.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ –≤–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Terraform –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ [`hw09_replication-lab/terraform`](./terraform/).

**–°—Ö–µ–º–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞:**
- **2 —à–∞—Ä–¥–∞ √ó 2 –∏–ª–∏ 3 —Ä–µ–ø–ª–∏–∫–∏** (4 –∏–ª–∏ 6 –Ω–æ–¥ ClickHouse)
- **3 Keeper-–Ω–æ–¥—ã** (–¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏)
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è —Å—Ä–µ–¥–∞, —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π volume

**–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞**

Terraform-–ø–∞–π–ø–ª–∞–π–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–º –∫–ª–∞—Å—Ç–µ—Ä–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `deploy_new_replicas` –≤ —Ñ–∞–π–ª–µ `variables.tf`.

- **–ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`deploy_new_replicas = false`):** –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è 4 –Ω–æ–¥—ã (2 —à–∞—Ä–¥–∞ √ó 2 —Ä–µ–ø–ª–∏–∫–∏).
- **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`deploy_new_replicas = true`):** –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –µ—â–µ 2 –Ω–æ–¥—ã, –¥–æ–≤–æ–¥—è –æ–±—â–µ–µ —á–∏—Å–ª–æ –¥–æ 6 (2 —à–∞—Ä–¥–∞ √ó 3 —Ä–µ–ø–ª–∏–∫–∏).

–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –¥–æ–±–∞–≤–ª—è—è –∏–ª–∏ —É–¥–∞–ª—è—è —Ä–µ–ø–ª–∏–∫–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥. Terraform –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–¥, –≤–∫–ª—é—á–∞—è —Å–µ–∫—Ü–∏—é `<remote_servers>`, –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞–º–∏**

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Terraform –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≥–∏–±–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç–∞–º–∏ ClickHouse —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `variables.tf`:
- `use_standard_ports` (boolean, default: `true`): –ï—Å–ª–∏ `true`, –≤—Å–µ –Ω–æ–¥—ã ClickHouse –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã (`ch_http_port`, `ch_tcp_port`, `ch_replication_port`). –ï—Å–ª–∏ `false`, –ø–æ—Ä—Ç—ã –±—É–¥—É—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
- `ch_http_port` (number, default: `8123`): –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTP –ø–æ—Ä—Ç.
- `ch_tcp_port` (number, default: `9000`): –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π TCP –ø–æ—Ä—Ç.
- `ch_replication_port` (number, default: `9001`): –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏.

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ –ø–æ—Ä—Ç–æ–≤, —á—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ä–µ–¥–∞—Ö.

---

### –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`config.xml.tpl`)

–í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –±–∞–∑–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ best-practice ClickHouse –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.

- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏:**
  - `<max_replicated_fetches_network_bandwidth_for_server>` –∏ `<max_replicated_sends_network_bandwidth_for_server>` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –≤—Ö–æ–¥—è—â–∏–π –∏ –∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ç—å –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–ª–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ.
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã MergeTree –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤:**
  - `<parts_to_throw_insert>`: –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Å—Ç–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (`Too many parts`).
  - `<replication_alter_partitions_sync>`: –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π `ALTER` –Ω–∞ –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å—Ö–µ–º—ã.
  - `<replicated_can_become_leader>`: –ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º —Ä–µ–ø–ª–∏–∫–∞–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ª–∏–¥–µ—Ä–∞–º–∏, —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å.
- **–°–µ–∫—Ü–∏—è `<compression>`**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (ZSTD –¥–ª—è –±–æ–ª—å—à–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π, LZ4 –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö) –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Å—Ç–µ–ø–µ–Ω–∏ —Å–∂–∞—Ç–∏—è.

> –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–±–∏—Ä–∞–ª–∏—Å—å —Å —É—á—ë—Ç–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –æ–ø—ã—Ç–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏–∑ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ClickHouse](https://clickhouse.com/docs/en/).

---

## –®–∞–≥ 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∏–º–ø–æ—Ä—Ç –¥–µ–º–æ-–¥–∞—Ç–∞—Å–µ—Ç–∞

### 1.1. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (4 –Ω–æ–¥—ã) —Å –ø–æ–º–æ—â—å—é Terraform.
```sh
cd hw09_replication-lab/terraform
terraform init
terraform apply -auto-approve
```
> –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ `apply`/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–ª–∞—Ç—å —É–∂–µ —Ç–æ–ª—å–∫–æ –∏–∑ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

### 1.2. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –±–∞–∑–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
–î–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `otus_default`. –û–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å –ø–æ–º–æ—â—å—é —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥—ã, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∏–∑ `clickhouse-client` –Ω–∞ —É–∑–ª–µ `clickhouse-01`:
```sql
CREATE DATABASE IF NOT EXISTS otus_default ON CLUSTER dwh_test;
```
–í –∫–∞—á–µ—Å—Ç–≤–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö [NYPL "What's on the menu?"](https://clickhouse.com/docs/en/getting-started/example-datasets/menus) ‚Äî –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ–Ω—é –ù—å—é-–ô–æ—Ä–∫—Å–∫–æ–π –ø—É–±–ª–∏—á–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

> **–í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–∞—Å–µ—Ç—É:**  
> –ü–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ –ò—é–ª—å 2025, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –ø—Ä–æ–µ–∫—Ç–∞ ["What's on the Menu?"](https://www.nypl.org/research/support/whats-on-the-menu) –±—ã–ª –≤—ã–≤–µ–¥–µ–Ω –∏–∑ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏–∑-–∑–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –∏ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–≤—à–µ–≥–æ —Ä–∏—Å–∫–∏ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
>
> –û–¥–Ω–∞–∫–æ —Å–∞–º–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ –ø—Ä—è–º—ã–º —Å—Å—ã–ª–∫–∞–º, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ClickHouse](https://clickhouse.com/docs/getting-started/example-datasets/menus), –æ—Ç–∫—É–¥–∞ –æ–Ω–∏ –∏ –±–µ—Ä—É—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –¥–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

–°–æ–∑–¥–∞—ë–º —á–µ—Ç—ã—Ä–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–µ `dwh_test` –≤ –±–∞–∑–µ `otus_default`:
```sql
CREATE TABLE IF NOT EXISTS otus_default.dish ON CLUSTER dwh_test
(
    id                   UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª—é–¥–∞',
    name                 String COMMENT '–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'
)
ENGINE = MergeTree
ORDER BY id;

CREATE TABLE IF NOT EXISTS otus_default.menu ON CLUSTER dwh_test
(
    id                   UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω—é',
    name                 String COMMENT '–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ–Ω—é –∏–ª–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è',
    sponsor              String COMMENT '–°–ø–æ–Ω—Å–æ—Ä –∏–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫ –º–µ–Ω—é',
    event                String COMMENT '–°–æ–±—ã—Ç–∏–µ, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –º–µ–Ω—é',
    venue                String COMMENT '–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è/–∑–∞–≤–µ–¥–µ–Ω–∏–µ',
    place                String COMMENT '–û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ (–∑–∞–ª, —Å—Ç–æ–ª –∏ —Ç.–ø.)',
    physical_description String COMMENT '–§–∏–∑–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ–Ω—é (—Ç–∏–ø, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è)',
    occasion             String COMMENT '–ü–æ–≤–æ–¥ –∏–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é',
    notes                String COMMENT '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏',
    call_number          String COMMENT '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –∏–ª–∏ –∞—Ä—Ö–∏–≤–Ω—ã–π –Ω–æ–º–µ—Ä',
    keywords             String COMMENT '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞',
    language             String COMMENT '–Ø–∑—ã–∫ –º–µ–Ω—é',
    date                 String COMMENT '–î–∞—Ç–∞ –º–µ–Ω—é (—Å—Ç—Ä–æ–∫–æ–π –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)',
    location             String COMMENT '–ì–æ—Ä–æ–¥ –∏–ª–∏ –∞–¥—Ä–µ—Å',
    location_type        String COMMENT '–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏ (–≥–æ—Ä–æ–¥, —Ä–µ–≥–∏–æ–Ω –∏ —Ç.–¥.)',
    currency             String COMMENT '–í–∞–ª—é—Ç–∞ —Ü–µ–Ω',
    currency_symbol      String COMMENT '–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã',
    status               String COMMENT '–°—Ç–∞—Ç—É—Å –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –º–µ–Ω—é',
    page_count           UInt16 COMMENT '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –º–µ–Ω—é',
    dish_count           UInt16 COMMENT '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª—é–¥ –≤ –º–µ–Ω—é'
)
ENGINE = MergeTree
ORDER BY id;

CREATE TABLE IF NOT EXISTS otus_default.menu_page ON CLUSTER dwh_test
(
    id                   UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–µ–Ω—é',
    menu_id              UInt32 COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω—é',
    page_number          UInt16 COMMENT '–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã',
    image_id             String COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã',
    full_height          UInt32 COMMENT '–í—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
    full_width           UInt32 COMMENT '–®–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'
)
ENGINE = MergeTree
ORDER BY id;

CREATE TABLE IF NOT EXISTS otus_default.menu_item ON CLUSTER dwh_test
(
    id                   UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª—é–¥–∞ –≤ –º–µ–Ω—é',
    menu_page_id         UInt32 COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–µ–Ω—é',
    dish_id              UInt32 COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª—é–¥–∞ (dish.id)',
    price                String COMMENT '–¶–µ–Ω–∞ –±–ª—é–¥–∞ (—Å—Ç—Ä–æ–∫–æ–π)',
    high_price           String COMMENT '–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω—ã (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)',
    low_price            String COMMENT '–ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω—ã (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)',
    section              String COMMENT '–†–∞–∑–¥–µ–ª –º–µ–Ω—é',
    subsection           String COMMENT '–ü–æ–¥—Ä–∞–∑–¥–µ–ª –º–µ–Ω—é',
    position             String COMMENT '–ü–æ–∑–∏—Ü–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ',
    description          String COMMENT '–û–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞'
)
ENGINE = MergeTree
ORDER BY id;
```

### 1.3. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º CSV-—Ñ–∞–π–ª—ã —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞:
```bash
../scripts/import_menu_dataset.sh
```
–°–∫—Ä–∏–ø—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤ NYPL, –∫–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã `Menu.csv`, `MenuItem.csv`, `MenuPage.csv`, `Dish.csv` –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/var/lib/clickhouse/user_files/` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å—Ç–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç `9000`.

> ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `TF_VAR_super_user_name` –∏ `TF_VAR_super_user_password` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `USE_STANDARD_PORTS` –≤ `false`:
> ```bash
> USE_STANDARD_PORTS=false ../scripts/import_menu_dataset.sh
> ```
> 
> –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –±—ã–ª–∏ –∑–∞–¥–∞–Ω—ã –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã –≤ terraform –ø–∞–π–ø–ª–∞–π–Ω–µ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `use_standard_ports` –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `false` –≤ `terraform.tfvars` –∏–ª–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ terraform –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å `-var="use_standard_ports=false"`.

> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É CSV:  
> - https://clickhouse.com/docs/en/interfaces/formats#csvwithnames  
> - https://clickhouse.com/docs/en/sql-reference/statements/copy/

> –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –∑–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:
> ```bash
> clickhouse-client --host <host> --query "INSERT INTO otus_default.menu_item FORMAT CSV" < MenuItem.csv
> ```
> –ò–ª–∏ —Ü–∏–∫–ª–æ–º:
> ```bash
> for tbl in menu menu_item menu_page dish; do
>   clickhouse-client --host <host> --query "INSERT INTO otus_default.$tbl FORMAT CSV" < ${tbl^}.csv
> done
> ```
> –≥–¥–µ `${tbl^}` ‚Äî Bash 4+, –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä.

*–†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –∏ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:*

<img src="../screenshots/hw09_replication-lab/01_import_script_execution.png" alt="–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö" width="600"/>

---

## –®–∞–≥ 2. –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
–î–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –Ω–µ –≤—Å–µ–≥–¥–∞ —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥—Ö–æ–¥ `CREATE TABLE ... AS SELECT ...`, —á—Ç–æ–±—ã –∞—Ç–æ–º–∞—Ä–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ClickHouse](https://clickhouse.com/docs/ru/sql-reference/statements/create/table#create-table-as-select), —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü –≤ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ –∏ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –¥–≤—É—Ö—à–∞–≥–æ–≤–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –ø–µ—Ä–µ–Ω–æ—Å–æ–º –ø–∞—Ä—Ç–∏—Ü–∏–π.

### –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
–í—ã–ø–æ–ª–Ω–∏–º –µ–¥–∏–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ —Å—Ä–∞–∑—É –∂–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è `date` –∏ `partition_state`.
```sql
CREATE TABLE IF NOT EXISTS otus_default.menu_item_denorm ON CLUSTER dwh_test
ENGINE = MergeTree
PARTITION BY toYYYYMM(date)
ORDER BY (date, menu_item_id, dish_id)
SETTINGS index_granularity = 8192
AS
WITH
    -- –ò—Å–ø–æ–ª—å–∑—É–µ–º WITH –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Å–µ–≤–¥–æ-—Å–ª—É—á–∞–π–Ω–æ–π –¥–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏. 564 ‚Äî —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –º–µ–∂–¥—É '2024-01-01' –∏ '2025-07-18'
    toDate('2024-01-01') + INTERVAL rowNumberInAllBlocks() % 564 DAY AS generated_date
SELECT
    generated_date AS date,
    toInt64(toStartOfDay(generated_date)) + cityHash64(menu_item.id, dish.id) % 86400 AS partition_state,
    menu_item.price,
    menu_item.high_price,
    menu_item.section,
    menu_item.subsection,
    menu_item.position,
    menu_item.description,
    menu_item.id                   AS menu_item_id,
    menu_item.menu_page_id         AS menu_item_menu_page_id,
    menu_item.dish_id              AS menu_item_dish_id,
    dish.id                        AS dish_id,
    dish.name                      AS dish_name,
    menu_page.id                   AS menu_page_id,
    menu_page.menu_id              AS menu_page_menu_id,
    menu_page.page_number          AS menu_page_number,
    menu_page.image_id             AS menu_page_image_id,
    menu_page.full_height          AS menu_page_full_height,
    menu_page.full_width           AS menu_page_full_width,
    menu.id                        AS menu_id,
    menu.name                      AS menu_name,
    menu.sponsor                   AS menu_sponsor,
    menu.event                     AS menu_event,
    menu.venue                     AS menu_venue,
    menu.place                     AS menu_place,
    menu.physical_description      AS menu_physical_description,
    menu.occasion                  AS menu_occasion,
    menu.notes                     AS menu_notes,
    menu.call_number               AS menu_call_number,
    menu.keywords                  AS menu_keywords,
    menu.language                  AS menu_language,
    menu.date                      AS menu_date,
    menu.location                  AS menu_location,
    menu.location_type             AS menu_location_type,
    menu.currency                  AS menu_currency,
    menu.currency_symbol           AS menu_currency_symbol,
    menu.status                    AS menu_status,
    menu.page_count                AS menu_page_count,
    menu.dish_count                AS menu_dish_count
FROM otus_default.menu_item
    JOIN otus_default.dish       ON menu_item.dish_id = dish.id
    JOIN otus_default.menu_page  ON menu_item.menu_page_id = menu_page.id
    JOIN otus_default.menu       ON menu_page.menu_id = menu.id
COMMENT '–î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∞—è –º–µ–Ω—é, –±–ª—é–¥–∞ –∏ –∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ã.';
```

> **üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:**  
> –î–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º—ã –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º `date` –∏ `partition_state` "–Ω–∞ –ª–µ—Ç—É". –ß—Ç–æ–±—ã –∑–Ω–∞—á–µ–Ω–∏—è –±—ã–ª–∏ —Ä–∞–∑–Ω—ã–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏, –∞ –Ω–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –¥–ª—è –≤—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `rowNumberInAllBlocks()`. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞—Ç, –∫ –ø—Ä–∏–º–µ—Ä—É, –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `cityHash64(menu_item.id)`, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø–µ—Ä–µ–∫–æ—Å–∞–º –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∏, –∫–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ, –∫ —Ä–∞–∑–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ö.

*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã:*

<img src="../screenshots/hw09_replication-lab/02_01_denormalized_table_created.png" alt="–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ DDL" width="600"/>

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏–º–µ–Ω–∏–º –∫–æ–¥–µ–∫–∏ —Å–∂–∞—Ç–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
```sql
ALTER TABLE otus_default.menu_item_denorm ON CLUSTER dwh_test 
    MODIFY COLUMN date CODEC(Delta(2), ZSTD(1)),
    MODIFY COLUMN partition_state CODEC(Delta(8), ZSTD(1));
```

> **üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:**  
> - **`PARTITION BY toYYYYMM(date)`**: –ú—ã –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Å—è—Ü–∞–º. –≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è time-series –¥–∞–Ω–Ω—ã—Ö. ClickHouse –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö (–ø–∞—Ä—Ç–∏—Ü–∏—è—Ö), —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –µ–º—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ `date` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `WHERE date >= '2025-01-01'`) —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É, –∞ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏.
> - **`ORDER BY (date, ...)`**: –ö–ª—é—á —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `date`, —á—Ç–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–ª—é—á–æ–º –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç ClickHouse –æ—á–µ–Ω—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –¥–∏—Å–∫–µ –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
> - **`SETTINGS index_granularity = 8192`**: –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–µ–µ, —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–¥–Ω—É "–≥—Ä–∞–Ω—É–ª—É" –∏–Ω–¥–µ–∫—Å–∞. –ö–∞–∂–¥—ã–µ 8192 —Å—Ç—Ä–æ–∫–∏ ClickHouse —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç "–∑–∞—Å–µ—á–∫—É" —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞. –ü—Ä–∏ –ø–æ–∏—Å–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–Ω —Å–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —ç—Ç–∏ –∑–∞—Å–µ—á–∫–∏, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≥—Ä–∞–Ω—É–ª, –∞ –Ω–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Ä—è–¥.
> - **`CODEC(Delta, ZSTD)`**: –ú—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ –∫–æ–¥–µ–∫–∏. `Delta` –≤—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (—á—Ç–æ –æ—á–µ–Ω—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞—Ç –∏ timestamp'–æ–≤), –∞ –∑–∞—Ç–µ–º `ZSTD` —Å–∂–∏–º–∞–µ—Ç —ç—Ç–∏ –¥–µ–ª—å—Ç—ã. –≠—Ç–æ –¥–∞—ë—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ–µ —Å–∂–∞—Ç–∏–µ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º `LZ4`.
>
> –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± —ç—Ç–∏—Ö —Ç–µ—Ö–Ω–∏–∫–∞—Ö:
> - [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ CREATE TABLE](https://clickhouse.com/docs/ru/sql-reference/statements/create/table)
> - [Habr - Clickhouse: —Å–∂–∏–º–∞–µ–º –¥–∞–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ](https://habr.com/ru/articles/718618/)
> - [Optimizing ClickHouse Compression for Fun and Profit](https://clickhouse.com/blog/optimize-clickhouse-codecs-compression-schema)

---

## –®–∞–≥ 3. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é
–¢–µ–ø–µ—Ä—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é ‚Äî –æ—Å–Ω–æ–≤—É –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏. –ü—Ä–æ—Ü–µ—Å—Å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö DDL-–∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º —Å—Ö–µ–º—ã –∏ –¥–∞–Ω–Ω—ã—Ö.

1.  **–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö**
    –í—ã–ø–æ–ª–Ω—è–µ–º –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü–µ—Ä–≤—ã–π —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É, –≤—Ç–æ—Ä–æ–π ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤ –Ω–µ—ë –¥–∞–Ω–Ω—ã–µ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –Ω–æ–¥—ã.

    ```sql
    -- –®–∞–≥ 3.1: –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é —Ç–∞–±–ª–∏—Ü—É, –∫–ª–æ–Ω–∏—Ä—É—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π.
    -- ORDER BY –∏ PARTITION BY –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ menu_item_denorm.
    CREATE TABLE IF NOT EXISTS otus_default.menu_item_denorm_replicated ON CLUSTER dwh_test
        CLONE AS otus_default.menu_item_denorm
        ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/otus_default/menu_item_denorm_local/{uuid}', '{replica}');

    -- –®–∞–≥ 3.2: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.
    -- –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–ª–∏–∫–∏ –µ—ë —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    ALTER TABLE otus_default.menu_item_denorm_replicated ON CLUSTER dwh_test
        ATTACH PARTITION ALL FROM otus_default.menu_item_denorm;
    ```

    > **üí° –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å?**
    > - **`CREATE ... CLONE ...`**: –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ ‚Äî production best-practice –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏. –û–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–ø–∏—Ä—É—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏—Å—Ö–æ–¥–Ω–æ–π (`ORDER BY`, `PARTITION BY`, `SETTINGS` –∏ —Ç.–¥.), –ø–æ—ç—Ç–æ–º—É –∏—Ö –Ω–µ –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ.
    > - **`ALTER ... ATTACH ...`**: –•–æ—Ç—è `CLONE` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã—Ö, –≤ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `MergeTree` –≤ `ReplicatedMergeTree` –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ —Ä–µ–ø–ª–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç–æ–π, –æ–∂–∏–¥–∞—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç "—Å–æ—Å–µ–¥–µ–π". –ö–æ–º–∞–Ω–¥–∞ `ATTACH` —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–ª–∏–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –∏–º–µ—é—â–∏–µ—Å—è –Ω–∞ –µ—ë –¥–∏—Å–∫–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –æ—Ç `menu_item_denorm`, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥—ë–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –†–µ–ø–ª–∏–∫–∏ –º–æ–≥—É—Ç –æ–∂–∏–¥–∞—Ç—å `fetch` —Å –¥—Ä—É–≥–∏—Ö –Ω–æ–¥, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞—Ç—å –µ–≥–æ, –µ—Å–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ "–∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã" —á–µ—Ä–µ–∑ `ATTACH`. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ issue [#53180](https://github.com/ClickHouse/ClickHouse/issues/53180).
    > - **–ü—É—Ç—å –≤ Keeper**: –ü—É—Ç—å `/clickhouse/tables/{shard}/otus_default/menu_item_denorm_local/{uuid}` —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞–∫—Ä–æ—Å—ã `{shard}` –∏ `{uuid}`, –∫–æ—Ç–æ—Ä—ã–µ ClickHouse –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–∞ ID —à–∞—Ä–¥–∞ –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ä–µ–ø–ª–∏–∫–∏. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —É –∫–∞–∂–¥–æ–π —Ä–µ–ø–ª–∏–∫–∏ –≤ Keeper –±—É–¥–µ—Ç —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.

<img src="../screenshots/hw09_replication-lab/03_01_replicated_table_created.png" alt="–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ DDL –¥–ª—è replicated-—Ç–∞–±–ª–∏—Ü—ã" width="600"/>

2.  **–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã**:
    ```sql
    RENAME TABLE otus_default.menu_item_denorm TO otus_default.menu_item_denorm_base,
                 otus_default.menu_item_denorm_replicated TO otus_default.menu_item_denorm_local
    ON CLUSTER dwh_test;
    ```
    > **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ú—ã –Ω–µ —É–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –µ—ë –≤ `_base`. –û–Ω–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –Ω–∞–º –≤ **–®–∞–≥–µ 5** –≤ –∫–∞—á–µ—Å—Ç–≤–µ "—à–∞–±–ª–æ–Ω–∞" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –Ω–æ–≤—ã—Ö –Ω–æ–¥–∞—Ö –ø–æ—Å–ª–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞.

<img src="../screenshots/hw09_replication-lab/03_02_replicated_table_renamed.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–º–µ–Ω—ã –∏–º–µ–Ω —Ç–∞–±–ª–∏—Ü" width="600"/>

3. **–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é**:
    –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –∫–∞–∂–¥–∞—è —Ä–µ–ø–ª–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã `menu_item_denorm_local` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å.
   ```sql
    SELECT
        getMacro('replica') AS replica,
        hostName() AS host,
        count() AS part_count
    FROM clusterAllReplicas('dwh_test', system.parts)
    WHERE table = 'menu_item_denorm_local'
      AND database = 'otus_default'
      AND active
    GROUP BY replica, host
    ORDER BY replica, part_count;
    ```
*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã:*

<img src="../screenshots/hw09_replication-lab/03_03_replica_parts_check.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–æ–≤ –ø–æ —Ä–µ–ø–ª–∏–∫–∞–º" width="800"/>

> **‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ —Ä–∞–∑–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–∞—Ä—Ç–∏—Ü–∏–π (–∫—É—Å–∫–æ–≤)**
> –°—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É—Å–∫–æ–≤ (`part_count`) –Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è. –≠—Ç–æ **–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** –ø—Ä–∏ –¥–∞–Ω–Ω–æ–º —Å–ø–æ—Å–æ–±–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ **–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π** –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
>
> - **–ü—Ä–∏—á–∏–Ω–∞:** –ó–∞–ø—Ä–æ—Å `CREATE TABLE ... AS SELECT` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ –∫–ª–∞—Å—Ç–µ—Ä–∞. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `rowNumberInAllBlocks()`, –Ω–µ–±–æ–ª—å—à–∏–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ —Ç–∞–π–º–∏–Ω–≥–∞—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `JOIN` –∏–ª–∏ —Ñ–æ–Ω–æ–≤—ã—Ö `MERGE`-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é —Ä–∞–∑–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫—É—Å–∫–æ–≤ (parts) –¥–ª—è –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ö–æ–≥–¥–∞ –º—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–ø–ª–∏–∫–∏ —á–µ—Ä–µ–∑ `ATTACH PARTITION`, –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ "–ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç" —ç—Ç–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫—É—Å–∫–∏.
> - **Production best practice:** –í –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ä–µ–¥–∞—Ö –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ —Ä–µ–ø–ª–∏–∫ (–≤–∫–ª—é—á–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥: –¥–∞–Ω–Ω—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è (`INSERT`) —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω—É —Ä–µ–ø–ª–∏–∫—É –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–¥–∞. ClickHouse –∑–∞—Ç–µ–º —Å–∞–º —Ç–∏—Ä–∞–∂–∏—Ä—É–µ—Ç —ç—Ç–∏ –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è, —á—Ç–æ –æ–Ω–∏ –±—É–¥—É—Ç –±–∞–π—Ç-–≤-–±–∞–π—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω—ã.
>
> –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã, –∏ –∫–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

## –®–∞–≥ 4. –°–æ–∑–¥–∞–Ω–∏–µ Distributed-—Ç–∞–±–ª–∏—Ü—ã
–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Å–µ–º —Ä–µ–ø–ª–∏–∫–∞–º –∏ —à–∞—Ä–¥–∞–º –ø—Ä–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç–µ —Å —Ç–∞–±–ª–∏—Ü–µ–π, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∫–∞–∫ —Å –µ–¥–∏–Ω—ã–º —Ü–µ–ª—ã–º —Å–æ–∑–¥–∞–¥–∏–º `Distributed`-—Ç–∞–±–ª–∏—Ü—É. –¢–∞–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ –≤—Å–µ–º —à–∞—Ä–¥–∞–º –∫–ª–∞—Å—Ç–µ—Ä–∞.
```sql
CREATE TABLE IF NOT EXISTS otus_default.menu_item_denorm ON CLUSTER dwh_test
AS otus_default.menu_item_denorm_local
ENGINE = Distributed(
    'dwh_test',                         -- –ò–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞
    'otus_default',                     -- –ë–î –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
    'menu_item_denorm_local',           -- –ò–º—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
    toYYYYMM(date)                      -- –ö–ª—é—á —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è
);
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã:*

<img src="../screenshots/hw09_replication-lab/04_create_table_menu_dist.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã" width="600"/>

> **üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—é:**  
> - **–î–≤–∏–∂–æ–∫ `Distributed` –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ**, –∞ –ª–∏—à—å —è–≤–ª—è–µ—Ç—Å—è "–ø—Ä–æ–∫—Å–∏" –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º –Ω–∞ —à–∞—Ä–¥–∞—Ö. –ü–æ—ç—Ç–æ–º—É –æ–Ω –Ω–µ –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π `ORDER BY` –∏–ª–∏ `PARTITION BY` ‚Äî —ç—Ç–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (`menu_item_denorm_local`).
> - –í –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `toYYYYMM(date)`. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `cityHash64` –æ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞, —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è time-series –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è –¥–∞—ë—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
> - **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** –ó–∞–ø—Ä–æ—Å—ã, —Ñ–∏–ª—å—Ç—Ä—É—é—â–∏–µ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü), –±—É–¥—É—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–º—É —à–∞—Ä–¥—É, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
> - **–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å:** –£–ø—Ä–æ—â–∞–µ—Ç—Å—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ—à–∞—Ä–¥–æ–≤–æ.
> - **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ —à–∞—Ä–¥–∞–º –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã "—Ä–∞–∑–¥—É–≤–∞–Ω–∏—è" –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ `INSERT ... SELECT`, –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —à–∞—Ä–¥–∞—Ö.
>
> –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤—ã–±–æ—Ä–µ –∫–ª—é—á–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –≤ —Å—Ç–∞—Ç—å—è—Ö:
> - [Habr - –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä ClickHouse](https://habr.com/ru/companies/wildberries/articles/896060/)
> - [Habr - Oracle/ClickHouse. DWH. –ü–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ —Å—Ä–µ–¥—Å—Ç–≤–æ –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö](https://habr.com/ru/articles/762960/)

---

## –®–∞–≥ 5. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–ø–ª–∏–∫
Terraform-–ø–∞–π–ø–ª–∞–π–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–≤—É—Ö –Ω–æ–≤—ã—Ö —Ä–µ–ø–ª–∏–∫ (`clickhouse-05` –∏ `clickhouse-06`) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏.

1.  **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Terraform**:
    –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥ `hw09_replication-lab/terraform` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:
    ```sh
    terraform apply -var="deploy_new_replicas=true" -auto-approve
    ```
    –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∏—Ä—É–µ—Ç Terraform:
    - **–°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã** –¥–ª—è –¥–≤—É—Ö –Ω–æ–≤—ã—Ö –Ω–æ–¥: `clickhouse-05` (—à–∞—Ä–¥ 1, —Ä–µ–ø–ª–∏–∫–∞ 3) –∏ `clickhouse-06` (—à–∞—Ä–¥ 2, —Ä–µ–ø–ª–∏–∫–∞ 3).
    - **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `config.xml` –¥–ª—è *–≤—Å–µ—Ö* –Ω–æ–¥ (—Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö), –¥–æ–±–∞–≤–∏–≤ –≤ —Å–µ–∫—Ü–∏—é `remote_servers` –Ω–æ–≤—ã–µ —Ö–æ—Å—Ç—ã.
    - **–ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**: Terraform –æ–±–Ω–∞—Ä—É–∂–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Ö–µ—à–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (—á–µ—Ä–µ–∑ `labels`) –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª–∏ –Ω–æ–≤—É—é —Ç–æ–ø–æ–ª–æ–≥–∏—é –∫–ª–∞—Å—Ç–µ—Ä–∞.

*–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –∏ –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ Docker:*

<img src="../screenshots/hw09_replication-lab/05_01_terraform_script_output.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–ø–ª–æ—è –Ω–æ–≤—ã—Ö –Ω–æ–¥" width="600"/>

<img src="../screenshots/hw09_replication-lab/05_02_portainer_clickhouse_containers.png" alt="–ù–æ–≤—ã–µ –Ω–æ–¥—ã —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞" width="800"/>

2.  **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –Ω–æ–≤—ã—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö**:
    –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤—ã—Ö –Ω–æ–¥ –Ω–∞ –Ω–∏—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å `Replicated`-—Ç–∞–±–ª–∏—Ü—É. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —è–≤–Ω—ã–º DDL-–∑–∞–ø—Ä–æ—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞, –Ω–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–æ–≤—ã—Ö –±–ª–∞–≥–æ–¥–∞—Ä—è —Ñ–ª–∞–≥—É `IF NOT EXISTS`.

    > **–í–∞–∂–Ω–æ:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –Ω–æ–≤—ã—Ö –Ω–æ–¥–∞—Ö –Ω—É–∂–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ—Ç –∂–µ `uuid`, —á—Ç–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ –ø–µ—Ä–≤—ã—Ö 4-—Ö –Ω–æ–¥–∞—Ö. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–ø–ª–∏–∫ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç –∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è.
    > 
    > –ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —ç—Ç–æ—Ç `uuid`, –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ª—é–±–æ–π –∏–∑ "—Å—Ç–∞—Ä—ã—Ö" –Ω–æ–¥:
    > ```sql
    > SELECT 
    >     database, 
    >     name, 
    >     uuid 
    > FROM system.tables
    > WHERE database = 'otus_default'
    >   AND name = 'menu_item_denorm_local';
    > ```
    >
    > –ü–æ–ª—É—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `uuid` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –≤–º–µ—Å—Ç–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ `{uuid}` –≤ `ENGINE`-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –Ω–∏–∂–µ.

<img src="../screenshots/hw09_replication-lab/05_03_uuid_result.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–ø–ª–æ—è –Ω–æ–≤—ã—Ö –Ω–æ–¥" width="800"/>

```sql
CREATE TABLE IF NOT EXISTS otus_default.menu_item_denorm_local ON CLUSTER dwh_test
(
    -- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É, —Å–æ–∑–¥–∞–Ω–Ω—É—é –≤ –®–∞–≥–µ 2
    `date` Date COMMENT '–°–ª—É–∂–µ–±–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è' CODEC(Delta(2), ZSTD(1)),
    `partition_state` Int64 COMMENT '–°–ª—É–∂–µ–±–Ω—ã–π timestamp –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö' CODEC(Delta(8), ZSTD(1)),
    `price` String COMMENT '–¶–µ–Ω–∞ –±–ª—é–¥–∞ (—Å—Ç—Ä–æ–∫–æ–π)',
    `high_price` String COMMENT '–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω—ã (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)',
    `section` String COMMENT '–†–∞–∑–¥–µ–ª –º–µ–Ω—é',
    `subsection` String COMMENT '–ü–æ–¥—Ä–∞–∑–¥–µ–ª –º–µ–Ω—é',
    `position` String COMMENT '–ü–æ–∑–∏—Ü–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ',
    `description` String COMMENT '–û–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞',
    `menu_item_id` UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª—é–¥–∞ –≤ –º–µ–Ω—é (menu_item.id)',
    `menu_item_menu_page_id` UInt32 COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–µ–Ω—é (menu_item.menu_page_id)',
    `menu_item_dish_id` UInt32 COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª—é–¥–∞ (menu_item.dish_id)',
    `dish_id` UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª—é–¥–∞ (dish.id)',
    `dish_name` String COMMENT '–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞',
    `menu_page_id` UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–µ–Ω—é (menu_page.id)',
    `menu_page_menu_id` UInt32 COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω—é (menu_page.menu_id)',
    `menu_page_number` UInt16 COMMENT '–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã',
    `menu_page_image_id` String COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã',
    `menu_page_full_height` UInt32 COMMENT '–í—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
    `menu_page_full_width` UInt32 COMMENT '–®–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
    `menu_id` UInt32 COMMENT '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–Ω—é (menu.id)',
    `menu_name` String COMMENT '–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ–Ω—é –∏–ª–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è',
    `menu_sponsor` String COMMENT '–°–ø–æ–Ω—Å–æ—Ä –∏–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫ –º–µ–Ω—é',
    `menu_event` String COMMENT '–°–æ–±—ã—Ç–∏–µ, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –º–µ–Ω—é',
    `menu_venue` String COMMENT '–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è/–∑–∞–≤–µ–¥–µ–Ω–∏–µ',
    `menu_place` String COMMENT '–û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ (–∑–∞–ª, —Å—Ç–æ–ª –∏ —Ç.–ø.)',
    `menu_physical_description` String COMMENT '–§–∏–∑–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ–Ω—é (—Ç–∏–ø, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è)',
    `menu_occasion` String COMMENT '–ü–æ–≤–æ–¥ –∏–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é',
    `menu_notes` String COMMENT '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏',
    `menu_call_number` String COMMENT '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –∏–ª–∏ –∞—Ä—Ö–∏–≤–Ω—ã–π –Ω–æ–º–µ—Ä',
    `menu_keywords` String COMMENT '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞',
    `menu_language` String COMMENT '–Ø–∑—ã–∫ –º–µ–Ω—é',
    `menu_date` String COMMENT '–î–∞—Ç–∞ –º–µ–Ω—é (—Å—Ç—Ä–æ–∫–æ–π –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)',
    `menu_location` String COMMENT '–ì–æ—Ä–æ–¥ –∏–ª–∏ –∞–¥—Ä–µ—Å',
    `menu_location_type` String COMMENT '–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏ (–≥–æ—Ä–æ–¥, —Ä–µ–≥–∏–æ–Ω –∏ —Ç.–¥.)',
    `menu_currency` String COMMENT '–í–∞–ª—é—Ç–∞ —Ü–µ–Ω',
    `menu_currency_symbol` String COMMENT '–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã',
    `menu_status` String COMMENT '–°—Ç–∞—Ç—É—Å –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –º–µ–Ω—é',
    `menu_page_count` UInt16 COMMENT '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –º–µ–Ω—é',
    `menu_dish_count` UInt16 COMMENT '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª—é–¥ –≤ –º–µ–Ω—é'
)
ENGINE = ReplicatedMergeTree(
    '/clickhouse/tables/{shard}/otus_default/menu_item_denorm_local/ae08bca2-291a-4b49-86b9-b4b814fc18ed',
    '{replica}'
)
PARTITION BY toYYYYMM(date)
ORDER BY (date, menu_item_id, dish_id)
SETTINGS index_granularity = 8192;
```
> **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –≠—Ç–æ—Ç DDL-–∑–∞–ø—Ä–æ—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã, –≤–∫–ª—é—á–∞—è `ORDER BY`, `PARTITION BY`, –∫–æ–¥–µ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –û–Ω –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ç–∞–±–ª–∏—Ü—ã-—à–∞–±–ª–æ–Ω–∞.
> - –ù–∞ —Å—Ç–∞—Ä—ã—Ö –Ω–æ–¥–∞—Ö (`01`-`04`) –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞ `menu_item_denorm_local` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
> - –ù–∞ –Ω–æ–≤—ã—Ö –Ω–æ–¥–∞—Ö (`05`, `06`) –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –ø—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –≤–µ—Ä–Ω–æ–π —Å—Ö–µ–º–æ–π.
> - –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ Keeper, –æ–±–Ω–∞—Ä—É–∂–∏—Ç "—Å–æ—Å–µ–¥–µ–π" –ø–æ —à–∞—Ä–¥—É –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–Ω—ë—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å —É –Ω–∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

<img src="../screenshots/hw09_replication-lab/05_04_replicated_table_created.png" alt="–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ DDL –¥–ª—è replicated-—Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –Ω–æ–≤—ã—Ö –Ω–æ–¥–∞—Ö" width="600"/>

3.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**:
    –ß–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å, –ø—Ä–æ–≤–µ—Ä–∏–≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö:
    ```sql
    SELECT
        getMacro('replica') AS replica,
        hostName() AS host,
        count() AS part_count
    FROM clusterAllReplicas('dwh_test', system.parts)
    WHERE table = 'menu_item_denorm_local'
      AND database = 'otus_default'
      AND active
    GROUP BY replica, host
    ORDER BY replica, part_count;
    ```

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –Ω–æ–≤—ã—Ö –Ω–æ–¥–∞—Ö, –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø—Ä–æ–ª–∏–≤–∞—é—Ç—Å—è:
<img src="../screenshots/hw09_replication-lab/05_05_replica_parts_check.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–æ–≤ –ø–æ —Ä–µ–ø–ª–∏–∫–∞–º" width="800"/>

–ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, –∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Å–∫–æ–≤ –±—É–¥—É—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –¥—Ä—É–≥–∏–º –Ω–æ–¥–∞–º –∫–ª–∞—Å—Ç–µ—Ä–∞:
<img src="../screenshots/hw09_replication-lab/05_06_replica_parts_check.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Ç–æ–≥–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–æ–≤ –ø–æ —Ä–µ–ø–ª–∏–∫–∞–º" width="800"/>

4.  **–û—á–∏—Å—Ç–∫–∞**:
    –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–µ–ø–ª–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, "–±–∞–∑–æ–≤–∞—è" —Ç–∞–±–ª–∏—Ü–∞-—à–∞–±–ª–æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞.
    ```sql
    DROP TABLE IF EXISTS otus_default.menu_item_denorm_base ON CLUSTER dwh_test;
    ```

---

## –®–∞–≥ 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏–º –∑–∞–ø—Ä–æ—Å—ã –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ñ–∞–π–ª—ã.
1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å—Ç–µ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö:**

    –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤–∞ –ø–æ–¥—Ö–æ–¥–∞.

    **–°–ø–æ—Å–æ–± 1 (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π, —Å `remote()`) - –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞–Ω–∏—è:**
    –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ –∏–∑-–∑–∞ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–Ω–µ—Ç–∏–ø–æ–≤–æ–π –ø—É—Ç—å –∫ `users.xml`) ClickHouse –Ω–µ –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–µ—Å—Å–∏–∏ –∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `default`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    ```sql
    SELECT getMacro('replica') AS replica, *
    FROM remote(
        'clickhouse-01,clickhouse-02,clickhouse-03,clickhouse-04,clickhouse-05,clickhouse-06',
        'system',
        'parts',
        'your_user',      -- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–µ –∏–º—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        'your_password'   -- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –ø–∞—Ä–æ–ª—å
    )
    WHERE table = 'menu_item_denorm_local' AND database = 'otus_default'
    FORMAT JSONEachRow;
    ```

    **–°–ø–æ—Å–æ–± 2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π, —Å `clusterAllReplicas()`):**
    –≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ —è–≤–ª—è–µ—Ç—Å—è –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∏ –Ω–∞–¥—ë–∂–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏–∑ `config.xml`, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è —Ö–æ—Å—Ç–æ–≤ –∏ —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–æ–ª—è –≤ –∑–∞–ø—Ä–æ—Å–µ.
    ```sql
    SELECT getMacro('replica') AS replica, *
    FROM clusterAllReplicas('dwh_test', system.parts)
    WHERE table = 'menu_item_denorm_local' AND database = 'otus_default'
    FORMAT JSONEachRow;
    ```

    **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ñ–∞–π–ª:**
    –î–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `JSONEachRow` –≤ –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ `hw09_replication-lab/terraform` —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É:
    ```bash
    docker exec -i clickhouse-01 clickhouse-client \
      --user "${TF_VAR_super_user_name}" \
      --password "${TF_VAR_super_user_password}" \
      --query "SELECT getMacro('replica') AS replica, * FROM clusterAllReplicas('dwh_test', system.parts) WHERE table = 'menu_item_denorm_local' AND database = 'otus_default' FORMAT JSONEachRow" > ../../materials/hw09_replication-lab/parts.jsonl
    ```
    > **üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `TF_VAR_super_user_name` –∏ `TF_VAR_super_user_password`, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ –∑–∞–¥–∞—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Terraform.
    >
    > –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª–µ: [`parts.jsonl`](../materials/hw09_replication-lab/parts.jsonl).

2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–ø–ª–∏–∫:**
    ```sql
    SELECT * FROM system.replicas
    WHERE table = 'menu_item_denorm_local' AND database = 'otus_default'
    FORMAT JSONEachRow;
    ```
    –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ñ–∞–π–ª, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:
    ```bash
    docker exec -i clickhouse-01 clickhouse-client \
      --user "${TF_VAR_super_user_name}" \
      --password "${TF_VAR_super_user_password}" \
      --query "SELECT * FROM system.replicas WHERE table = 'menu_item_denorm_local' AND database = 'otus_default' FORMAT JSONEachRow" > ../../materials/hw09_replication-lab/replicas.jsonl
    ```
    > –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª–µ: [`replicas.jsonl`](../materials/hw09_replication-lab/replicas.jsonl).

*–°–∫—Ä–∏–Ω—à–æ—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤—ã–≤–æ–¥–∞:*

<img src="../screenshots/hw09_replication-lab/06_01_system_parts_remote.png" alt="system.parts —á–µ—Ä–µ–∑ remote() –¥–ª—è menu_replicated" width="600"/>
<img src="../screenshots/hw09_replication-lab/06_02_system_replicas.png" alt="system.replicas –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–µ –¥–ª—è menu_replicated" width="600"/>

---

## –®–∞–≥ 7. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –¥–∞–Ω–Ω—ã—Ö (TTL)
–î–æ–±–∞–≤–∏–º –≤ —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª–∏—Ç–∏–∫—É TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–∞–º–∏ –∫–æ–ª–æ–Ω–∫—É `date`.

1.  **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TTL** –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É:
    ```sql
    ALTER TABLE otus_default.menu_item_denorm_local ON CLUSTER dwh_test
    MODIFY TTL date + INTERVAL 7 DAY;
    ```
    > **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** TTL –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ `ReplicatedMergeTree` —Ç–∞–±–ª–∏—Ü–µ. `Distributed` —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –ª–∏—à—å –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.

2.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –∑–∞–ø—Ä–æ—Å–æ–º `SHOW CREATE TABLE`:
    ```sql
    SHOW CREATE TABLE otus_default.menu_item_denorm_local;
    ```
*–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `SHOW CREATE TABLE` —Å TTL:*

<img src="../screenshots/hw09_replication-lab/07_show_create_table.png" alt="SHOW CREATE TABLE —Å TTL –∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π" width="800"/>

---

## –®–∞–≥ 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ (—Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç)
–ò–º–∏—Ç–∏—Ä—É–µ–º —Å–±–æ–∏, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ –∫–ª–∞—Å—Ç–µ—Ä —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.

### –ö–µ–π—Å 1: –û—Ç–∫–∞–∑ –æ–¥–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏
–≠—Ç–æ—Ç —Ç–µ—Å—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–ª–∞—Å—Ç–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ —à–∞—Ä–¥–æ–≤ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Å—Ç—Ä–æ—è –æ–¥–Ω–∞ –∏–∑ —Ä–µ–ø–ª–∏–∫.

1.  **–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–¥–Ω—É –∏–∑ –Ω–æ–¥**, –Ω–∞–ø—Ä–∏–º–µ—Ä, `clickhouse-04` (—Ä–µ–ø–ª–∏–∫–∞ 2 —à–∞—Ä–¥–∞ 2):
    ```sh
    docker stop clickhouse-04
    ```

<img src="../screenshots/hw09_replication-lab/08_01_stopped_node.png" alt="–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è clickhouse-04 –Ω–æ–¥–∞" width="800"/>

2.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**  
    –í—ã–ø–æ–ª–Ω–∏–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥—Å—á—ë—Ç —Å—Ç—Ä–æ–∫ –∫ `Distributed`-—Ç–∞–±–ª–∏—Ü–µ. ClickHouse –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∂–∏–≤—ã–µ —Ä–µ–ø–ª–∏–∫–∏ (`clickhouse-02` –∏–ª–∏ `clickhouse-06`) —Ç–æ–≥–æ –∂–µ —à–∞—Ä–¥–∞, –∏ –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ.
    ```sql
    SELECT count() FROM otus_default.menu_item_denorm;
    ```

    *–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –ø—Ä–∏ –æ–¥–Ω–æ–π –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ:*
    
    <img src="../screenshots/hw09_replication-lab/08_02_read_without_one_node.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç SELECT –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ" width="800"/>

3.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö:**  
    –í—ã–ø–æ–ª–Ω–∏–º –≤—Å—Ç–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö. –î–≤–∏–∂–æ–∫ `Distributed` —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç, –Ω–∞ –∫–∞–∫–æ–π —à–∞—Ä–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∞ –≤–Ω—É—Ç—Ä–∏ —à–∞—Ä–¥–∞ –≤—ã–±–µ—Ä–µ—Ç –∂–∏–≤—É—é —Ä–µ–ø–ª–∏–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏. –≠—Ç–∞ –∑–∞–ø–∏—Å—å –ø–æ–ø–∞–¥—ë—Ç –≤ –æ—á–µ—Ä–µ–¥—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è `clickhouse-04`.
    ```sql
    INSERT INTO otus_default.menu_item_denorm (date, menu_item_id, dish_id) VALUES (today(), 9999999, 9999999);
    ```

    *–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –ø—Ä–∏ –æ–¥–Ω–æ–π –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ:*

    <img src="../screenshots/hw09_replication-lab/08_03_insert_without_one_node.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç INSERT –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ" width="600"/>

4.  **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏:**  
    –ü–æ—Å–∫–æ–ª—å–∫—É `clusterAllReplicas` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –Ω–æ–¥—ã, –∞ –∑–∞–ø—Ä–æ—Å –∫ `system.replicas` –Ω–∞ –æ–¥–Ω–æ–º —É–∑–ª–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –æ –Ω—ë–º —Å–∞–º–æ–º, –º—ã –Ω–µ –º–æ–∂–µ–º –µ–¥–∏–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç—É—Å "—É–ø–∞–≤—à–µ–π" —Ä–µ–ø–ª–∏–∫–∏. –û–¥–Ω–∞–∫–æ, –º—ã –º–æ–∂–µ–º —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ **–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ**. –î–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∂–∏–≤–æ–π —Ä–µ–ø–ª–∏–∫–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —à–∞—Ä–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä `clickhouse-01`, –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—ë —Å—Ç–∞—Ç—É—Å.
    ```sql
    -- –í—ã–ø–æ–ª–Ω—è–µ–º –∏–∑ clickhouse-client, –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –∫ clickhouse-01
    SELECT
        replica_name,
        is_readonly,
        is_session_expired,
        replica_is_active
    FROM system.replicas
    WHERE table = 'menu_item_denorm_local' AND database = 'otus_default';
    ```
    –¢–æ—Ç —Ñ–∞–∫—Ç, —á—Ç–æ `SELECT` –∏ `INSERT` (—à–∞–≥–∏ 2 –∏ 3) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –∞ –∂–∏–≤—ã–µ —Ä–µ–ø–ª–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞.

    *–°–∫—Ä–∏–Ω—à–æ—Ç —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º `system.replicas` –Ω–∞ –∂–∏–≤–æ–π –Ω–æ–¥–µ `clickhouse-01`:*

    <img src="../screenshots/hw09_replication-lab/08_04_system_replicas_state.png" alt="system.replicas –Ω–∞ –∂–∏–≤–æ–π –Ω–æ–¥–µ clickhouse-01" width="800"/>

5.  **–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–¥—É:**
    ```sh
    docker start clickhouse-04
    ```
    –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ Keeper, –æ–±–Ω–∞—Ä—É–∂–∏—Ç, —á—Ç–æ –æ—Ç—Å—Ç–∞–ª–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö —Ä–µ–ø–ª–∏–∫, –∏ –Ω–∞—á–Ω—ë—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å —É –Ω–∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫—É—Å–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

6.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö:**
    –¢–µ–ø–µ—Ä—å —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∑–∞–ø–∏—Å—å, —Å–¥–µ–ª–∞–Ω–Ω–∞—è –≤ —à–∞–≥–µ 3, —É—Å–ø–µ—à–Ω–æ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–ª–∞—Å—å –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –Ω–æ–¥—É `clickhouse-04`. –î–ª—è —ç—Ç–æ–≥–æ –ø–æ–¥–∫–ª—é—á–∏–º—Å—è –Ω–∞–ø—Ä—è–º—É—é –∫ –Ω–µ–π –∏ –≤—ã–ø–æ–ª–Ω–∏–º –∑–∞–ø—Ä–æ—Å –∫ **–ª–æ–∫–∞–ª—å–Ω–æ–π** —Ç–∞–±–ª–∏—Ü–µ.
    ```bash
    docker exec -i clickhouse-04 clickhouse-client \
      --user "${TF_VAR_super_user_name}" \
      --password "${TF_VAR_super_user_password}" \
      --query "SELECT * FROM otus_default.menu_item_denorm_local WHERE menu_item_id = 9999999"
    ```
    –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—è, —á—Ç–æ –Ω–æ–¥–∞ –ø–æ–ª—É—á–∏–ª–∞ –¥–∞–Ω–Ω—ã–µ, –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è –µ—ë –ø—Ä–æ—Å—Ç–æ—è.
    
    *–°–∫—Ä–∏–Ω—à–æ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞ `clickhouse-04`:*

    <img src="../screenshots/hw09_replication-lab/08_05_select_from_node_up.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç SELECT –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –Ω–æ–¥–µ" width="600"/>

### –ö–µ–π—Å 2: –û—Ç–∫–∞–∑ —Ü–µ–ª–æ–≥–æ —à–∞—Ä–¥–∞ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞
–≠—Ç–æ—Ç —Ç–µ—Å—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–∞–∂–Ω–æ–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ `Distributed` —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ —Å–±–æ–µ —Ü–µ–ª–æ–≥–æ —à–∞—Ä–¥–∞.

1.  **–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–æ–¥—ã –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞**, –Ω–∞–ø—Ä–∏–º–µ—Ä, —à–∞—Ä–¥–∞ 2 (`clickhouse-02`, `clickhouse-04`, `clickhouse-06`):
    ```sh
    docker stop clickhouse-02 clickhouse-04 clickhouse-06
    ```
    *–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —à–∞—Ä–¥–∞ 2:*

    <img src="../screenshots/hw09_replication-lab/08_06_shard_down.png" alt="–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —à–∞—Ä–¥–∞ 2" width="800"/>

2.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**  
    –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–π `SELECT` –∑–∞–ø—Ä–æ—Å –∫ `Distributed`-—Ç–∞–±–ª–∏—Ü–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–æ –≤—Å–µ–º —à–∞—Ä–¥–∞–º, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π.
    ```sql
    SELECT count() FROM otus_default.menu_item_denorm;
    ```
    *–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º —à–∞—Ä–¥–µ:*

    <img src="../screenshots/hw09_replication-lab/08_07_select_shard_down.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç SELECT –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º —à–∞—Ä–¥–µ" width="800"/>

3.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö:**  
    –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏–º `INSERT`. –í–æ–ø—Ä–µ–∫–∏ –æ–∂–∏–¥–∞–Ω–∏—è–º, —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è **—É—Å–ø–µ—à–Ω–æ** –∏ –±–µ–∑ –æ—à–∏–±–æ–∫. –≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã `Distributed` —Ç–∞–±–ª–∏—Ü (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `insert_distributed_sync=0`). –£–∑–µ–ª `clickhouse-01`, –ø—Ä–∏–Ω—è–≤—à–∏–π –∑–∞–ø—Ä–æ—Å, –≤–∏–¥–∏—Ç, —á—Ç–æ —Ü–µ–ª–µ–≤–æ–π —à–∞—Ä–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ —É —Å–µ–±—è –ª–æ–∫–∞–ª—å–Ω–æ. –û–Ω –±—É–¥–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ö, –ø–æ–∫–∞ —à–∞—Ä–¥ –Ω–µ –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è.
    ```sql
    INSERT INTO otus_default.menu_item_denorm (date, menu_item_id, dish_id) VALUES (today(), 8888888, 8888888);
    ```

    *–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º —à–∞—Ä–¥–µ:*

    <img src="../screenshots/hw09_replication-lab/08_08_insert_shard_down.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç INSERT –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º —à–∞—Ä–¥–µ" width="600"/>

    –í–∞–∂–Ω–æ! –ï—Å–ª–∏ –º—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø—Ä–æ—Å `SELECT` –≤—Å—ë —Ä–∞–≤–Ω–æ —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π, —Ç–∞–∫ –∫–∞–∫ —à–∞—Ä–¥ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è, –∞ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ –µ—â—ë –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã.

4.  **–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∞—Ä–¥:**
    ```sh
    docker start clickhouse-02 clickhouse-04 clickhouse-06
    ```

5.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö:**
    –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞—Ä–¥–∞ —É–∑–µ–ª-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä (`clickhouse-01`) –¥–æ–ª–∂–µ–Ω –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å —ç—Ç–æ –∏ –¥–æ—Å—Ç–∞–≤–∏—Ç—å "–∑–∞—Å—Ç—Ä—è–≤—à—É—é" –∑–∞–ø–∏—Å—å. –ü–æ–¥–æ–∂–¥–∞–≤ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è, –ø—Ä–æ–≤–µ—Ä–∏–º —ç—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–Ω—è—Ç–æ–π –Ω–æ–¥—ã (–∑–∞–º–µ–Ω—è—è N –Ω–∞ –Ω–æ–º–µ—Ä –Ω–æ–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ 02 / 04 / 06):
    ```bash
    docker exec -i clickhouse-N clickhouse-client \
      --user "${TF_VAR_super_user_name}" \
      --password "${TF_VAR_super_user_password}" \
      --query "SELECT * FROM otus_default.menu_item_denorm_local WHERE menu_item_id = 8888888"
    ```

    *–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞—Ä–¥–∞:*
    <img src="../screenshots/hw09_replication-lab/08_09_select_shard_up.png" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç SELECT –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞—Ä–¥–∞" width="600"/>

---

## –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–∏—é
–í —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞—è —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ TTL. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞–∫—Ä–æ—Å–æ–≤ `{shard}` –∏ `{replica}` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Terraform –ø–æ–∑–≤–æ–ª—è—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏ –ª–µ–≥–∫–æ –µ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å. –†–µ–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `ReplicatedMergeTree` –∏ ClickHouse Keeper –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –±—ã–ª–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ —Ö–æ–¥–µ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞.

---

## –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: –†–µ–ø–ª–∏–∫–∞—Ü–∏—è](https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/)
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: TTL](https://clickhouse.com/docs/en/sql-reference/statements/create/table/#ttl)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏](https://clickhouse.com/docs/en/operations/system-tables/replicas/)
- [ClickHouse Keeper ‚Äî –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π —Å–µ—Ä–≤–∏—Å —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö](https://clickhouse.com/docs/en/operations/server-configuration-keeper/)
- [–í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å ON CLUSTER (ClickHouse docs)](https://clickhouse.com/docs/en/sql-reference/statements/insert-into#insert-into-on-cluster)
