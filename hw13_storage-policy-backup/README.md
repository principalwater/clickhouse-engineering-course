# Homework #13: Storage Policy –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ü–µ–ª–∏](#–æ–ø–∏—Å–∞–Ω–∏–µ-–∑–∞–¥–∞–Ω–∏—è-–∏-—Ü–µ–ª–∏)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è –∏ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è-–∏-–∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ-–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ)
- [–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ-–ø—Ä–æ–≤–µ—Ä–∫–∏-–∏-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
- [1. –°—Ü–µ–Ω–∞—Ä–∏–π —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –∏ —É–¥–∞–ª–µ–Ω–Ω—ã–º –±—ç–∫–∞–ø–æ–º](#1-—Å—Ü–µ–Ω–∞—Ä–∏–π-—Å-–ª–æ–∫–∞–ª—å–Ω—ã–º-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º-–∏-—É–¥–∞–ª–µ–Ω–Ω—ã–º-–±—ç–∫–∞–ø–æ–º)
- [2. –°—Ü–µ–Ω–∞—Ä–∏–π —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º –±—ç–∫–∞–ø–æ–º –Ω–∞ SSD](#2-—Å—Ü–µ–Ω–∞—Ä–∏–π-—Å-–ª–æ–∫–∞–ª—å–Ω—ã–º-—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º-–∏-–ª–æ–∫–∞–ª—å–Ω—ã–º-–±—ç–∫–∞–ø–æ–º-–Ω–∞-ssd)
- [3. –°—Ü–µ–Ω–∞—Ä–∏–π —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º Storage –∏ Compute (S3BackedMergeTree)](#3-—Å—Ü–µ–Ω–∞—Ä–∏–π-—Å-—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º-storage-–∏-compute-s3backedmergetree)
- [4. –ê–Ω–∞–ª–∏–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π](#4-–∞–Ω–∞–ª–∏–∑-–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)
- [–û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–∏—é](#–æ–±—â–∏–µ-–≤—ã–≤–æ–¥—ã-–ø–æ-–∑–∞–¥–∞–Ω–∏—é)
- [FAQ / –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π](#faq--—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π)
- [–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤](#—Å–ø–∏—Å–æ–∫-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

---

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ü–µ–ª–∏
–í –¥–∞–Ω–Ω–æ–º –¥–æ–º–∞—à–Ω–µ–º –∑–∞–¥–∞–Ω–∏–∏ –±—É–¥—É—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã –º–µ—Ö–∞–Ω–∏–∑–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é `Storage Policy` –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ S3. –ë—É–¥—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ —Å—Ä–∞–≤–Ω–µ–Ω—ã —Ç—Ä–∏ –ø–æ–¥—Ö–æ–¥–∞:
1. **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ + —É–¥–∞–ª–µ–Ω–Ω—ã–π –±—ç–∫–∞–ø** ‚Äî –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º SSD, –±—ç–∫–∞–ø—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º MinIO
2. **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ + –ª–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø –Ω–∞ SSD** ‚Äî –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º SSD, –±—ç–∫–∞–ø—ã –Ω–∞ Samsung T7 SSD —á–µ—Ä–µ–∑ MinIO
3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ Storage –∏ Compute** ‚Äî ClickHouse —Å S3BackedMergeTree –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è –∏ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ
–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω–∞—è, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –æ–ø–∏—Å–∞–Ω–Ω–∞—è –≤ –º–æ–¥—É–ª–µ [`base-infra/ch_with_storage`](../base-infra/ch_with_storage/README.md).

### –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∫–µ—Ç–æ–≤ S3 (Production-Ready)

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ production-—Å—Ä–µ–¥–∞—Ö, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –±–∞–∫–µ—Ç–æ–≤ MinIO –≤—ã–Ω–µ—Å–µ–Ω–æ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ Terraform. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥ "pre-apply script", –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±–∞–∫–µ—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥—Ä—É–≥–∏–º —Ä–µ—Å—É—Ä—Å–∞–º.

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
1.  **–ó–∞–ø—É—Å–∫ MinIO:** Terraform —Å–ø–µ—Ä–≤–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã `minio-local-storage` –∏ `minio-remote-backup`.
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ `null_resource` (`wait_for_local_minio` –∏ `wait_for_remote_minio`) –æ–∂–∏–¥–∞—é—Ç, –ø–æ–∫–∞ API MinIO –Ω–µ —Å—Ç–∞–Ω—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã.
3.  **–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∫–µ—Ç–æ–≤:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ MinIO, `null_resource` "minio_buckets" –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã MinIO Client (`mc`) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∫–µ—Ç–æ–≤.
4.  **–ö–æ–º–∞–Ω–¥—ã `mc`:**
    *   `mc alias set ...`: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø—ã –∫ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º MinIO.
    *   `mc mb --ignore-existing ...`: –°–æ–∑–¥–∞–µ—Ç –±–∞–∫–µ—Ç, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
5.  **–ó–∞–ø—É—Å–∫ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤:** –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ `mc` –∏ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∫–µ—Ç–æ–≤ Terraform –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤, –≤–∫–ª—é—á–∞—è ClickHouse.

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ —Ä–µ—à–∞–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É –≤ Terraform, –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤.

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
–î–ª—è —Ä–∞–±–æ—Ç—ã —ç—Ç–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã –Ω–∞ –º–∞—à–∏–Ω–µ, —Å –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Terraform, –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω [MinIO Client (mc)](https://min.io/docs/minio/linux/reference/minio-mc.html).

### –ê–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ
-   **–•–æ—Å—Ç-–º–∞—à–∏–Ω–∞ (`mac-studio-foxes-home.local`):** Mac Studio (M2 Max, 32 –ì–ë RAM)
-   **–í–Ω–µ—à–Ω–∏–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å (–ª–æ–∫–∞–ª—å–Ω—ã–π S3):** Samsung Portable SSD T7 2 –¢–ë (Thunderbolt 4)
-   **–£–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (`water-rpi.local`):** Raspberry Pi 5 (8 –ì–ë RAM, 512 –ì–ë NVMe SSD), Debian 12 (Bookworm)

---

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—å—Å—è –≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –∫–∞–∂–¥–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–æ–π:
```bash
source env/clickhouse.env
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –§–∞–π–ª `env/clickhouse.env` —Å–æ–¥–µ—Ä–∂–∏—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ClickHouse –∏ MinIO, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è Terraform –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ò–∑–±–µ–≥–∞–Ω–∏–µ hardcoded –ø–∞—Ä–æ–ª–µ–π –≤ –∫–æ–º–∞–Ω–¥–∞—Ö
- **–ì–∏–±–∫–æ—Å—Ç—å:** –õ–µ–≥–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥
- **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—é:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
- `$CH_USER`, `$CH_PASSWORD` ‚Äî –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ClickHouse
- `$BI_USER`, `$BI_PASSWORD` ‚Äî –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è BI-—Å–∏—Å—Ç–µ–º—ã
- `$MINIO_USER`, `$MINIO_PASSWORD` ‚Äî –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è MinIO (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

1.  **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ SSH-–¥–æ—Å—Ç—É–ø –∫ Docker:**
    –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã Terraform –º–æ–≥ —É–ø—Ä–∞–≤–ª—è—Ç—å Docker –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ö–æ—Å—Ç–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ—Å—à–æ–≤–Ω–æ–µ SSH-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
    
    *   **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª–∏–µ–Ω—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):** –î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à —Ñ–∞–π–ª `~/.ssh/config` –∑–∞–ø–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–ª—é—á –∫–∞–∂–¥—ã–π —Ä–∞–∑.
        ```
        Host water-rpi.local
          HostName water-rpi.local
          User principalwater
          IdentityFile ~/.ssh/water-rpi
        ```
    *   **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `~/.ssh/config` (–∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –≤ `ssh-agent`), –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤–∞—à–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ. –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—É—Å—Ç–æ–π) –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ö–æ—Å—Ç–µ.
        ```sh
        docker --host ssh://water-rpi.local ps
        ```
    –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `principalwater` –Ω–∞ `water-rpi.local` —Å–æ—Å—Ç–æ–∏—Ç –≤ –≥—Ä—É–ø–ø–µ `docker`.

2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–µ–≥–æ SSD (–¥–ª—è –°—Ü–µ–Ω–∞—Ä–∏—è 2):**
    –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∏—Å–∫ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø—É—Ç–∏, —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤ `local_minio_path`.
    ```sh
    ls -l /Volumes/t7_ssd
    ```
    
**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í –°—Ü–µ–Ω–∞—Ä–∏–∏ 2 MinIO –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 9020 (API) –∏ 9021 (–≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å), —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –æ—Å–Ω–æ–≤–Ω—ã–º MinIO –¥–ª—è S3-—Ö—Ä–∞–Ω–µ–Ω–∏—è.

---

## 1. –°—Ü–µ–Ω–∞—Ä–∏–π —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –∏ —É–¥–∞–ª–µ–Ω–Ω—ã–º –±—ç–∫–∞–ø–æ–º
-   **–î–∞–Ω–Ω—ã–µ ClickHouse:** –•—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º SSD —Ö–æ—Å—Ç-–º–∞—à–∏–Ω—ã (`mac-studio-foxes-home.local`). –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è "–≥–æ—Ä—è—á–∏—Ö" –¥–∞–Ω–Ω—ã—Ö.
-   **–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π S3 (MinIO –Ω–∞ `water-rpi.local`).

### 1.1. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (`storage_type = "local_ssd"`).
```sh
cd base-infra/ch_with_storage

terraform init

terraform apply -auto-approve \
  -var="storage_type=local_ssd" \
  -var="enable_remote_backup=true"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ClickHouse
# –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
source env/clickhouse.env
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:*

<img src="../screenshots/hw13_storage-policy-backup/01_deploy_local.png" alt="–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –°—Ü–µ–Ω–∞—Ä–∏—è 1" width="800"/>

### 1.2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```bash
# –í—ã–ø–æ–ª–Ω—è–µ–º SQL-–∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ ClickHouse –∫–ª–∏–µ–Ω—Ç
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --multiquery << 'EOF'
CREATE DATABASE IF NOT EXISTS test_db ON CLUSTER dwh_test;
CREATE TABLE IF NOT EXISTS test_db.sample_table ON CLUSTER dwh_test (id UInt64, data String)
ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/sample_table/{uuid}', '{replica}') ORDER BY id;
INSERT INTO test_db.sample_table SELECT number, randomString(10) FROM numbers(1000);
EOF
```

### 1.3. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤—ã–≥—Ä—É–∑–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `create_remote`, –∫–æ—Ç–æ—Ä–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–≤–∞ –¥–µ–π—Å—Ç–≤–∏—è:
1.  **`create`**: –°–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –Ω–∞ –¥–∏—Å–∫–µ, –¥–æ—Å—Ç—É–ø–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É `clickhouse-backup`.
2.  **`upload`**: –°—Ä–∞–∑—É –∂–µ –≤—ã–≥—Ä—É–∂–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—É—é –∫–æ–ø–∏—é –≤ —É–¥–∞–ª–µ–Ω–Ω–æ–µ S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
```bash
# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
docker exec clickhouse-backup clickhouse-backup create_remote "backup_local_$(date +%Y%m%d_%H%M%S)"
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞:*

<img src="../screenshots/hw13_storage-policy-backup/02_create_backup_local.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –¥–ª—è –°—Ü–µ–Ω–∞—Ä–∏—è 1" width="800"/>

### 1.4. –ò–º–∏—Ç–∞—Ü–∏—è —Å–±–æ—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
1.  **–£–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É:**
    ```bash
    docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --query "DROP TABLE IF EXISTS test_db.sample_table ON CLUSTER dwh_test SYNC;"
    ```
2.  **–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –±—ç–∫–∞–ø–∞:**
    –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.
    ```bash
    LATEST_BACKUP=$(docker exec clickhouse-backup clickhouse-backup list remote | grep '^backup' | tail -1 | awk '{print $1}')
    docker exec clickhouse-backup clickhouse-backup restore_remote $LATEST_BACKUP
    ```
3.  **–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ:**
    ```bash
    docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --query "SELECT count() FROM test_db.sample_table;"
    ```
*–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞:*

<img src="../screenshots/hw13_storage-policy-backup/03_01_drop_local.png" alt="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –°—Ü–µ–Ω–∞—Ä–∏–∏ 1" width="600"/>

<img src="../screenshots/hw13_storage-policy-backup/03_02_restore_local.png" alt="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –°—Ü–µ–Ω–∞—Ä–∏–∏ 1" width="800"/>

---

## 2. –°—Ü–µ–Ω–∞—Ä–∏–π —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º –±—ç–∫–∞–ø–æ–º –Ω–∞ SSD
-   **–î–∞–Ω–Ω—ã–µ ClickHouse:** –•—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º SSD —Ö–æ—Å—Ç-–º–∞—à–∏–Ω—ã (`mac-studio-foxes-home.local`). –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
-   **–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π MinIO, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –Ω–∞ –≤–Ω–µ—à–Ω–µ–º SSD Samsung T7. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –±—ç–∫–∞–ø–æ–≤, –Ω–æ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Ö–æ—Å—Ç—É.

### 2.1. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
–£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—É—é —Å —Ç–∏–ø–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏—è `local_ssd_backup`.
```sh
terraform destroy -auto-approve

terraform apply -auto-approve -var="storage_type=local_ssd_backup"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ClickHouse
source env/clickhouse.env
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/04_deploy_local_backup.png" alt="–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –°—Ü–µ–Ω–∞—Ä–∏—è 2" width="800"/>

### 2.2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–∏—Å–∫–µ (–∫–∞–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ 1).
```bash
# –í—ã–ø–æ–ª–Ω—è–µ–º SQL-–∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ ClickHouse –∫–ª–∏–µ–Ω—Ç
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --multiquery << 'EOF'
CREATE DATABASE IF NOT EXISTS test_db ON CLUSTER dwh_test;
CREATE TABLE IF NOT EXISTS test_db.sample_table_local_backup ON CLUSTER dwh_test (id UInt64, data String)
ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/sample_table_local_backup/{uuid}', '{replica}') ORDER BY id;
INSERT INTO test_db.sample_table_local_backup SELECT number, randomString(10) FROM numbers(1000);
EOF
```

*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/05_create_data_local_backup.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –°—Ü–µ–Ω–∞—Ä–∏–∏ 2" width="800"/>

### 2.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–∏—Å–∫–µ, MinIO –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ç–∫–∞–ø–æ–≤.
```bash
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT table, disk_name, path FROM system.parts WHERE database = 'test_db' AND table = 'sample_table_local_backup' LIMIT 5;"
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/06_check_local_storage.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –°—Ü–µ–Ω–∞—Ä–∏–∏ 2" width="800"/>

### 2.4. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
–í —ç—Ç–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –±—ç–∫–∞–ø—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ Samsung T7 SSD —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π MinIO.
```bash
# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π MinIO (Samsung T7)
docker exec clickhouse-backup clickhouse-backup create_remote "backup_local_ssd_$(date +%Y%m%d_%H%M%S)"
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/07_create_backup_local_ssd.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π SSD" width="800"/>

```bash
# –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–±–æ–π
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --query "DROP TABLE IF EXISTS test_db.sample_table_local_backup ON CLUSTER dwh_test SYNC;"
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/08_drop_table_local_backup.png" alt="–£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Å–±–æ—è" width="800"/>

```bash
# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
LATEST_BACKUP=$(docker exec clickhouse-backup clickhouse-backup list remote | grep '^backup' | tail -1 | awk '{print $1}')
docker exec clickhouse-backup clickhouse-backup restore_remote $LATEST_BACKUP

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --query "SELECT count() FROM test_db.sample_table_local_backup;"
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/09_verify_restore_local_backup.png" alt="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö" width="800"/>

---

## 3. –°—Ü–µ–Ω–∞—Ä–∏–π —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º Storage –∏ Compute (S3BackedMergeTree)

–≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º storage –∏ compute, –∏—Å–ø–æ–ª—å–∑—É—è ClickHouse —Å S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–∞ –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ClickHouse –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥
-   **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** ClickHouse –∫–ª–∞—Å—Ç–µ—Ä —Å S3BackedMergeTree + MinIO –∫–∞–∫ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ  
-   **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º compute –∏ storage —Ä–µ—Å—É—Ä—Å–∞–º–∏
-   **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–∏, –ª—É—á—à–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è "—Ö–æ–ª–æ–¥–Ω—ã—Ö" –¥–∞–Ω–Ω—ã—Ö
-   **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** 
    - [Separation of Storage and Compute](https://clickhouse.com/docs/guides/separation-storage-compute)
    - [Configuring External Storage](https://clickhouse.com/docs/operations/storing-data#configuring-external-storage)

### –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞ 1: Crash-–ø–µ—Ç–ª–∏ ClickHouse –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤**
–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ ClickHouse –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ S3 –¥–∏—Å–∫–æ–≤:
```
IDisk::checkAccessImpl() and IDisk::startup() fatal exceptions
```

**–†–µ—à–µ–Ω–∏–µ 1: –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
–ß–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –±—ã–ª–æ –≤—ã—è–≤–ª–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤ –≤ storage policy
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç endpoint URL
- –ü—Ä–æ–±–ª–µ–º—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è S3 –±—ã–ª–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª `config.xml`, —á—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–ª–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º ClickHouse.

**–†–µ—à–µ–Ω–∏–µ 2: –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
–°–æ–≥–ª–∞—Å–Ω–æ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ClickHouse](https://clickhouse.com/docs/operations/storing-data#configuring-external-storage), —Å–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```xml
<!-- storage_config.xml.tpl -->
<clickhouse>
  <storage_configuration>
    <disks>
      <s3_disk>
        <type>s3</type>
        <endpoint>http://minio-local-storage:9000/clickhouse-storage-bucket/</endpoint>
        <access_key_id>${minio_root_user}</access_key_id>
        <secret_access_key>${minio_root_password}</secret_access_key>
        <metadata_path>/var/lib/clickhouse/disks/s3_disk/</metadata_path>
        <skip_access_check>true</skip_access_check>
      </s3_disk>
      <s3_cache>
        <type>cache</type>
        <disk>s3_disk</disk>
        <path>/var/lib/clickhouse/disks/s3_cache/</path>
        <max_size>10Gi</max_size>
      </s3_cache>
    </disks>
    <policies>
      <s3_main>
        <volumes>
          <main>
            <disk>s3_disk</disk>
          </main>
        </volumes>
      </s3_main>
    </policies>
  </storage_configuration>
</clickhouse>
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3: Terraform –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å, —á—Ç–æ–±—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å.

**–†–µ—à–µ–Ω–∏–µ 3: –£—Å–ª–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
–î–æ–±–∞–≤–ª–µ–Ω—ã —É—Å–ª–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –≤ Terraform:

```sh
# –°–æ–∑–¥–∞–Ω–∏–µ storage_config.xml —Ç–æ–ª—å–∫–æ –¥–ª—è s3_ssd —Ä–µ–∂–∏–º–∞
resource "local_file" "storage_config_xml" {
  count = var.storage_type == "s3_ssd" ? length(local.clickhouse_nodes) : 0
  content = templatefile("${path.module}/samples/storage_config.xml.tpl", {
    minio_root_user     = var.minio_root_user
    minio_root_password = var.minio_root_password
  })
  filename   = "${var.clickhouse_base_path}/${local.clickhouse_nodes[count.index].name}/etc/clickhouse-server/config.d/storage_config.xml"
  depends_on = [null_resource.mk_clickhouse_dirs]
}

# –£—Å–ª–æ–≤–Ω–æ–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
dynamic "mounts" {
  for_each = var.storage_type == "s3_ssd" ? [1] : []
  content {
    target    = "/etc/clickhouse-server/config.d/storage_config.xml"
    source    = abspath("${var.clickhouse_base_path}/${each.key}/etc/clickhouse-server/config.d/storage_config.xml")
    type      = "bind"
    read_only = true
  }
}
```

**–§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ä—ã–≤: skip_access_check**
–ö–ª—é—á–µ–≤—ã–º –º–æ–º–µ–Ω—Ç–æ–º —Å—Ç–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `skip_access_check=true`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª–∏–ª ClickHouse –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞ –∫ S3 –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –∏–∑–±–µ–∂–∞–≤ crash-–ø–µ—Ç–µ–ª—å.

### 3.1. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ S3BackedMergeTree
–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º ClickHouse —Å S3-–¥–∏—Å–∫–∞–º–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è storage –∏ compute:

```sh
# –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
terraform destroy -auto-approve

# –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å S3 storage policy
terraform apply -auto-approve \
  -var="storage_type=s3_ssd" \
  -var="enable_remote_backup=true"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ClickHouse
source env/clickhouse.env
```
*–†–µ–∑—É–ª—å—Ç–∞—Ç:* <img src="../screenshots/hw13_storage-policy-backup/10_deploy_s3.png" alt="–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –°—Ü–µ–Ω–∞—Ä–∏—è 3" width="600"/>

### 3.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ S3BackedMergeTree

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ S3 –¥–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∏—Å–∫–∏
docker exec clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT name, type FROM system.disks ORDER BY name"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º storage policies
docker exec clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT * FROM system.storage_policies"
```

*–†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ S3BackedMergeTree:*

<img src="../screenshots/hw13_storage-policy-backup/11_s3_initialization.png" alt="–£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è S3 –¥–∏—Å–∫–æ–≤ –∏ storage policies" width="800"/>

S3BackedMergeTree –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω:
- `s3_disk` - –æ—Å–Ω–æ–≤–Ω–æ–π S3 –¥–∏—Å–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- `s3_cache` - –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏  
- `s3_main` - storage policy –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

### 3.3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å S3BackedMergeTree

–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –∏—Å–ø–æ–ª—å–∑—É—é—â—É—é S3 –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö:

```bash
# –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å S3 storage policy
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD --multiquery << 'EOF'
CREATE DATABASE IF NOT EXISTS test_db ON CLUSTER dwh_test;

CREATE TABLE test_db.s3_backed_table ON CLUSTER dwh_test (
    id UInt64,
    timestamp DateTime,
    user_name String,
    value Float64
) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/s3_backed_table/{uuid}', '{replica}')
ORDER BY (id, timestamp)
SETTINGS storage_policy = 's3_main';

-- –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
INSERT INTO test_db.s3_backed_table 
SELECT 
    number as id,
    now() - interval number hour as timestamp,
    concat('user_', toString(number % 1000)) as user_name,
    rand() / 1000000 as value
FROM numbers(10000);
EOF
```

üí° **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** ClickHouse –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç S3BackedMergeTree –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ S3 storage policy.

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ S3 bucket
mc ls local_storage/clickhouse-storage-bucket/ --recursive | head -5
```

*–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è S3BackedMergeTree —Ç–∞–±–ª–∏—Ü—ã:*

<img src="../screenshots/hw13_storage-policy-backup/12_create_s3_table.png" alt="–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å S3BackedMergeTree" width="800"/>

### 3.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã S3BackedMergeTree

–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç S3 –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º storage policy —Ç–∞–±–ª–∏—Ü—ã
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SHOW CREATE TABLE test_db.s3_backed_table;"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —á–∞—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã  
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT table, disk_name, path FROM system.parts WHERE database = 'test_db' AND table = 's3_backed_table' LIMIT 5;"

# –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT user_name, count(*), avg(value) FROM test_db.s3_backed_table GROUP BY user_name ORDER BY count(*) DESC LIMIT 10;"
```

*–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ S3BackedMergeTree —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:*

<img src="../screenshots/hw13_storage-policy-backup/13_verify_s3_storage.png" alt="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã S3BackedMergeTree" width="800"/>

### 3.5. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞:**
1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ClickHouse –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –±–µ–∑ crash-–ø–µ—Ç–µ–ª—å
2. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:** S3 –¥–∏—Å–∫–∏ (`s3_disk`, `s3_cache`) –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã  
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** Storage policy `s3_main` –≥–æ—Ç–æ–≤–∞ –¥–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —É—Å–∫–æ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –¥–∞–Ω–Ω—ã–º
5. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —á–∏—Å—Ç–æ—Ç–∞:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ compute –∏ storage –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è S3 –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
- **–£—Å–ª–æ–≤–Ω–æ—Å—Ç—å:** –†–µ—Å—É—Ä—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `storage_type=s3_ssd`
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ Terraform
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 3.6. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ S3-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–í–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è S3Table engine:**
- **–ê—Ä—Ö–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –•–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–¥–∫–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è
- **ETL –ø—Ä–æ—Ü–µ—Å—Å—ã:** –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ S3 –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏  
- **–§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:** –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ S3

**–ü—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞:**
```bash
# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT avg(value) FROM test_db.s3_backed_table;" --time

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –≥—Ä—É–ø–ø–∞–º
docker exec -i clickhouse-01 clickhouse-client --user $CH_USER --password $CH_PASSWORD \
  --query "SELECT value % 100 as group, count(*) FROM test_db.s3_backed_table GROUP BY group ORDER BY group LIMIT 10;"
```

*–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ S3BackedMergeTree:*

<img src="../screenshots/hw13_storage-policy-backup/14_s3_performance.png" alt="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ S3BackedMergeTree" width="800"/>

üí° **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** S3BackedMergeTree –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–∞–º –¥–∞–Ω–Ω—ã—Ö, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Ö–æ—Ä–æ—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä—è –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é.

---

## 4. –ê–Ω–∞–ª–∏–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### 4.1. –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ `ch_with_storage` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å:

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã–º backup:**
```sh
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–¥–∞–ª–µ–Ω–Ω—ã–π backup –æ—Ç–∫–ª—é—á–µ–Ω (enable_remote_backup=false)
terraform apply

# –í–∫–ª—é—á–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–π backup
terraform apply -var="enable_remote_backup=true"
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
- **–†–µ–∂–∏–º A:** `storage_type=local_ssd` + `enable_remote_backup=true` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π - —Å—Ç–∞–±–∏–ª—å–Ω—ã–π)
- **–†–µ–∂–∏–º B:** `storage_type=local_ssd_backup` (–ª–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø –Ω–∞ SSD)
- **–†–µ–∂–∏–º C:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å S3 —á–µ—Ä–µ–∑ S3Table engine (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π)

### 4.2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
–ù–∞ –±–∞–∑–µ –∏–º–µ—é—â–µ–≥–æ—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω—ã –∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
-   **Hot/Cold Storage:** –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `Storage Policy`, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å "–≥–æ—Ä—è—á–∏–µ" –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü) –Ω–∞ –±—ã—Å—Ç—Ä–æ–º –ª–æ–∫–∞–ª—å–Ω–æ–º SSD, –∞ "—Ö–æ–ª–æ–¥–Ω—ã–µ" ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –Ω–∞ –±–æ–ª–µ–µ –º–µ–¥–ª–µ–Ω–Ω—ã–π, –Ω–æ –æ–±—ä–µ–º–Ω—ã–π S3 (–≤–Ω–µ—à–Ω–∏–π SSD –∏–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä).
-   **–ë—ç–∫–∞–ø –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π S3:** –í —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞, –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å MinIO –Ω–∞ –≤–Ω–µ—à–Ω–µ–º SSD –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤, —Ä–∞–∑–Ω–µ—Å—è –∏—Ö –ø–æ —Ä–∞–∑–Ω—ã–º –±–∞–∫–µ—Ç–∞–º.
-   **–ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:** –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è `compute` –∏ `storage` –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å ClickHouse —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω —Ö—Ä–∞–Ω–∏–ª –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º S3. –≠—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –Ω–æ –¥–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å –≤ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏.

---

## –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–∏—é

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `ch_with_storage` —Å –≥–∏–±–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–∞–º–∏ —á–µ—Ä–µ–∑ `count` —É—Å–ª–æ–≤–∏—è
2. **–ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ backup**: –í–≤–µ–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `enable_remote_backup` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ backup
3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –º–µ–∂–¥—É –∫–æ—Ä–Ω–µ–≤—ã–º –º–æ–¥—É–ª–µ–º –∏ –º–æ–¥—É–ª–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞
4. **Production-ready –ø–æ–¥—Ö–æ–¥**: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ S3 –±–∞–∫–µ—Ç–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã  
- **Storage Policy**: –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º `local_ssd` 
- **S3 Integration**: –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MinIO —á–µ—Ä–µ–∑ S3Table engine
- **Backup & Recovery**: –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –±–µ–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ –ø—Ä–∏ `enable_remote_backup=false`
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è | –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (ch_with_storage) |
|--------|---------------|-------------------------------|
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è | –ú–æ–¥—É–ª—å–Ω–∞—è |
| Remote backup | –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è | –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π |
| –õ–æ–≥–∏–∫–∞ —É—Å–ª–æ–≤–∏–π | –ü—Ä–æ–±–ª–µ–º—ã —Å `count` | –ì–∏–±–∫–∏–µ —É—Å–ª–æ–≤–∏—è |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ | –í—ã—Å–æ–∫–∞—è |
| –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ | –ù–µ–≤–æ–∑–º–æ–∂–Ω–∞ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |

---

## FAQ / –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π

### –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è MinIO bucket "426 Upgrade Required"

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞:
```
Error running command 'mc mb --ignore-existing local_storage/clickhouse-storage-bucket': exit status 1.
Output: mc: <ERROR> Unable to make bucket `local_storage/clickhouse-storage-bucket`. 426 Upgrade Required
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Ä—Ç MinIO (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 9010) –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 9010)
lsof -i :9010
```

**–†–µ—à–µ–Ω–∏–µ:**
1. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
   ```bash
   terraform apply -auto-approve \
     -var="storage_type=s3_ssd" \
     -var="local_minio_port=9014"
   ```

2. **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—Ç –≤ `terraform.tfvars`:
   ```hcl
   local_minio_port = 9014
   ```

3. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –∑–∞–Ω–∏–º–∞—é—â–∏–π –ø–æ—Ä—Ç (–µ—Å–ª–∏ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ):
   ```bash
   # –ù–∞–π—Ç–∏ PID –ø—Ä–æ—Ü–µ—Å—Å–∞
   lsof -i :9010
   # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
   kill <PID>
   ```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û–±—ã—á–Ω–æ –ø–æ—Ä—Ç 9010 –∑–∞–Ω—è—Ç Logitech G HUB (`lghub_age`). –í —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç, –∞ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.

### SSH –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ —Ç–∏–ø–∞ "SSH authentication failed" –∏–ª–∏ "no supported methods remain".

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é:**
   ```bash
   ssh your-user@your-host.local "echo 'test'"
   ```

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º –±–µ–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ backup:**
   ```bash
   terraform apply -auto-approve \
     -var="storage_type=s3_ssd" \
     -var="enable_remote_backup=false"
   ```

3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH agent (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è):**
   ```bash
   eval "$(ssh-agent -s)"
   ssh-add ~/.ssh/your-super-key
   ```

### ClickHouse –æ—à–∏–±–∫–∏ "Cannot resolve host (clickhouse-05, clickhouse-06)"

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ª–æ–≥–∞—Ö ClickHouse –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
```
<Warning> DNSResolver: Cannot resolve host (clickhouse-05), error 0: Host not found.
<Warning> DNSResolver: Cannot resolve host (clickhouse-06), error 0: Host not found.
```

**–ü—Ä–∏—á–∏–Ω–∞:** –í S3 bucket –æ—Å—Ç–∞–ª–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–æ–¥ (6 –≤–º–µ—Å—Ç–æ 4).

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ:**
   ```bash
   # –°–ù–ê–ß–ê–õ–ê –æ—á–∏—Å—Ç–∏—Ç—å S3 –±–∞–∫–µ—Ç—ã (–ø–æ–∫–∞ MinIO –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
   mc rb --force local_storage/clickhouse-storage-bucket 2>/dev/null || true
   mc rb --force remote_backup/clickhouse-backup-bucket 2>/dev/null || true
   
   # –ó–∞—Ç–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã
   terraform destroy -auto-approve
   
   # –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   terraform apply -auto-approve -var="storage_type=s3_ssd"
   source env/clickhouse.env
   ```

2. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –æ—á–∏—Å—Ç–∫–∞ S3 –¥–∞–Ω–Ω—ã—Ö –≤—Ä—É—á–Ω—É—é:**
   ```bash
   # –ï—Å–ª–∏ bucket –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ mc
   mc rm --recursive local_storage/clickhouse-storage-bucket/
   mc rm --recursive remote_backup/clickhouse-backup-bucket/
   ```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞, –Ω–æ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –¥–∞–Ω–Ω—ã—Ö –≤ S3.

---

## –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ClickHouse: –ü–æ–ª–∏—Ç–∏–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö](https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-multiple-volumes)
- [–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Altinity/clickhouse-backup](https://github.com/Altinity/clickhouse-backup)
